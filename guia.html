<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Guia de Manejo em Crise</title>

<link rel="manifest" href="guia-manifest.json">
<meta name="theme-color" content="#0b0b0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{
    --bg:#0b0b0f; --text:#f4f4f5; --muted:#9aa0a6; --line:rgba(255,255,255,.10);
    --panel:#14141c; --chip:#1b1b24;
    --good:rgba(120,255,180,.10); --warn:rgba(255,180,80,.10); --bad:rgba(255,90,90,.10);
    --r:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:16px 14px 64px}

  /* HERO FAIXA */
  .hero-faixa{width:100%;overflow:hidden;border-radius:14px;margin:6px 0 14px}
  .hero-faixa img{width:100%;height:110px;object-fit:cover;display:block}

  header{padding:6px 4px 14px;border-bottom:1px solid var(--line);margin-bottom:12px}
  h1{margin:0 0 6px;font-size:20px;letter-spacing:.2px}
  .sub{margin:0;color:var(--muted);font-size:13.5px;line-height:1.45}

  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{
    border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);
    padding:10px 12px; border-radius:999px; font-weight:900; font-size:12.5px; cursor:pointer;
  }
  .btn:active{transform:scale(.99)}
  .btn.primary{background:rgba(255,255,255,.12)}
  .btn.danger{border-color:rgba(255,90,90,.22); background:rgba(255,90,90,.08)}

  .tabs{
    display:flex; gap:8px; margin:14px 0 12px;
    position:sticky; top:0; background:rgba(11,11,15,.92); backdrop-filter: blur(10px);
    padding:10px 4px; border-bottom:1px solid var(--line); z-index:10;
  }
  .tab{
    flex:1; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text);
    padding:10px; border-radius:999px; font-weight:900; font-size:12.5px; cursor:pointer;
  }
  .tab.active{background:rgba(255,255,255,.12)}

  .grid{display:grid;grid-template-columns:1fr;gap:10px;padding:8px 4px}
  @media(min-width:920px){.grid{grid-template-columns:1fr 1fr}}
  .card{
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    border-radius:var(--r);
    padding:14px;
  }
  .card h3{margin:0 0 10px;font-size:14px}
  .hint{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.4}
  .full{grid-column:1/-1}
  .good{background:var(--good)}
  .warn{background:var(--warn)}
  .bad{background:var(--bad)}

  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="search"], select{
    width:100%;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    outline:none;
    font-size:13px;
  }
  .mini{color:var(--muted);font-size:12px}

  /* Tiles (inteligentes) */
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .tile{
    flex:1 1 240px;
    border:1px solid rgba(255,255,255,.14);
    background:var(--chip);
    border-radius:14px;
    padding:10px 10px;
    position:relative;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .tile:active{transform:scale(.99)}
  .ico{
    width:32px;height:32px;border-radius:10px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    flex:0 0 32px;
    font-size:16px;
    user-select:none;
  }
  .tile .txt{flex:1}
  .tile .t{font-weight:900;font-size:13.2px;line-height:1.25}
  .tile .d{color:var(--muted);font-size:12px;line-height:1.35;margin-top:4px}
  .actions{display:flex;gap:6px;flex:0 0 auto}
  .act{
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:12px;
    padding:7px 9px;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .act:active{transform:scale(.99)}
  .act.copy{background:rgba(255,255,255,.10)}
  .tile.fav{border-color:rgba(255,255,255,.35)}

  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:rgba(0,0,0,.78); color:white; padding:10px 12px;
    border:1px solid rgba(255,255,255,.16); border-radius:999px;
    font-size:13px; opacity:0; pointer-events:none; transition:.18s;
  }
  .toast.show{opacity:1}

  .footer{
    margin-top:18px;
    font-size:12px;
    color:var(--muted);
    border-top:1px solid rgba(255,255,255,.08);
    padding-top:10px;
  }

  /* Modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{width:min(760px,92vw);background:#0f0f16;border:1px solid var(--line);border-radius:18px;padding:14px}
  .modal h2{margin:0 0 6px;font-size:16px}
  .modal p{margin:0 0 12px;color:var(--muted);font-size:12.5px;line-height:1.45}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .list{max-height:52vh;overflow:auto;border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
  .item{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  .item:last-child{border-bottom:none}
  .item .t{font-weight:900;font-size:12.5px}
  .item .m{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .box{flex:1 1 160px;border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
  .kpi .n{font-size:18px;font-weight:900}
  .kpi .l{color:var(--muted);font-size:12px}
</style>
</head>

<body>
<div class="wrap">

  <div class="hero-faixa">
    <img src="hero22.png" alt="Guia de Manejo em Crise">
  </div>

  <header>
    <h1>Guia de Manejo em Crise</h1>
    <p class="sub">Primeiro regula. Depois conversa. O foco inicial Ã© reduzir escalada e preservar vÃ­nculo.</p>

    <div class="row">
      <button class="btn danger" id="btnEmergencia">âš ï¸ MODO CRISE</button>
      <button class="btn primary" id="btnHistorico">ğŸ•’ HistÃ³rico</button>
      <button class="btn" id="btnFavoritos">â˜… Favoritos</button>
      <button class="btn" id="btnExportar">â¬‡ï¸ Exportar</button>
      <button class="btn" id="btnStats">ğŸ“Š Uso</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="crise">âš ï¸ CRISE AGORA</button>
    <button class="tab" data-tab="depois">ğŸ§© DEPOIS</button>
    <button class="tab" data-tab="prevencao">ğŸ› ï¸ PREVENÃ‡ÃƒO</button>
  </nav>

  <!-- CRISE -->
  <section class="panel" id="crise" style="display:block">
    <div class="grid">

      <div class="card full good">
        <h3>Controle rÃ¡pido â€¢ 30â€“90s</h3>
        <p class="hint">Sem debate. Tom baixo, frases curtas, sem ironia. Primeiro regula o corpo, depois discute o conteÃºdo.</p>

        <div class="bar">
          <div style="flex:1 1 260px">
            <select id="intensidade">
              <option value="0">Intensidade da crise: selecione</option>
              <option value="1">1â€“3 (leve): tensÃ£o / irritaÃ§Ã£o</option>
              <option value="2">4â€“6 (mÃ©dia): choro / raiva / impulso</option>
              <option value="3">7â€“10 (alta): escalada / risco</option>
            </select>
          </div>
          <button class="btn primary" id="btnPlano">â–¶ï¸ Gerar plano</button>
          <button class="btn" id="btnTimer">â±ï¸ Timer 60s</button>
          <div class="mini" id="timerTxt">Timer: parado</div>
        </div>

        <div class="hr"></div>

        <div class="chips">
          <!-- AÃ‡Ã•ES -->
          <div class="tile" data-kind="action" data-tag="check" data-use="Tom baixo. Frases curtas. Uma ideia por frase. Sem ironia.">
            <div class="ico">âœ…</div>
            <div class="txt">
              <div class="t">Checklist (voz e forma)</div>
              <div class="d">Use agora. NÃ£o Ã© texto pra mandar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1" title="Favoritar">â˜…</button>
              <button class="act" data-usebtn="1" title="Marcar como usado">â–¶ï¸</button>
            </div>
          </div>

          <div class="tile" data-kind="action" data-tag="mantra" data-use="Agora nÃ£o Ã© hora de discutir. Primeiro a gente acalma. Depois conversa.">
            <div class="ico">ğŸ§ </div>
            <div class="txt">
              <div class="t">Mantra (sequÃªncia correta)</div>
              <div class="d">Repita 1 frase. Sem explicar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>

          <div class="tile" data-kind="action" data-tag="ambiente" data-use="Reduz estÃ­mulo: menos barulho, menos gente, menos argumento.">
            <div class="ico">ğŸ”‡</div>
            <div class="txt">
              <div class="t">Ambiente (reduzir estÃ­mulo)</div>
              <div class="d">Ajuste o cenÃ¡rio antes de falar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Scripts (aqui faz sentido copiar)</h3>
        <p class="hint">Use 1 sÃ³. Copie se for mandar por mensagem. Se estiver presente, leia e fale.</p>

        <div class="chips">
          <div class="tile" data-kind="script" data-tag="presenca" data-script="Eu tÃ´ aqui. Vamos respirar um pouco.">
            <div class="ico">ğŸ—£ï¸</div>
            <div class="txt">
              <div class="t">â€œEu tÃ´ aqui.â€</div>
              <div class="d">PresenÃ§a sem pressÃ£o.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1" title="Copiar">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="validacao" data-script="Eu vejo que tÃ¡ doendo muito agora.">
            <div class="ico">ğŸ«€</div>
            <div class="txt">
              <div class="t">â€œEu vejo que dÃ³i.â€</div>
              <div class="d">Valida sentimento sem validar comportamento.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="sequencia" data-script="Agora nÃ£o Ã© hora de discutir. Eu fico do seu lado e a gente conversa depois.">
            <div class="ico">ğŸ§­</div>
            <div class="txt">
              <div class="t">â€œDepois a gente conversa.â€</div>
              <div class="d">Organiza a sequÃªncia sem brigar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card bad">
        <h3>Proibidos (nÃ£o copie â€” sÃ³ lembre)</h3>
        <p class="hint">Ironia/indireta/sermÃ£o = gasolina. Aqui Ã© â€œaÃ§Ã£oâ€, nÃ£o â€œtextoâ€.</p>

        <div class="chips">
          <div class="tile" data-kind="action" data-tag="nao1" data-use="Sem ironia. Sem indireta. Sem sarcasmo. Sem humilhaÃ§Ã£o.">
            <div class="ico">â›”</div>
            <div class="txt">
              <div class="t">Regra anti-incÃªndio</div>
              <div class="d">Se vocÃª tÃ¡ irritado, fale menos.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>

          <div class="tile" data-kind="action" data-tag="nao2" data-use="NÃ£o Ã© hora de convencer. Ã‰ hora de reduzir ameaÃ§a e estÃ­mulo.">
            <div class="ico">ğŸ§¯</div>
            <div class="txt">
              <div class="t">Foco certo</div>
              <div class="d">Convencer agora piora. Regular melhora.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card full warn">
        <h3>Se a pessoa se afastar</h3>
        <p class="hint">Perseguir costuma piorar. Use 1 script curto.</p>

        <div class="chips">
          <div class="tile" data-kind="script" data-tag="af1" data-script="VocÃª pode ir. SÃ³ me avisa quando chegar.">
            <div class="ico">ğŸšª</div>
            <div class="txt">
              <div class="t">â€œPode ir. SÃ³ avisa quando chegar.â€</div>
              <div class="d">EspaÃ§o com comunicaÃ§Ã£o mÃ­nima.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="af2" data-script="Eu nÃ£o vou te perseguir. Eu continuo aqui.">
            <div class="ico">ğŸ§±</div>
            <div class="txt">
              <div class="t">â€œEu nÃ£o vou te perseguir.â€</div>
              <div class="d">DÃ¡ espaÃ§o sem abandono.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="action" data-tag="af3" data-use="Afastamento nÃ£o Ã© abandono quando existe comunicaÃ§Ã£o mÃ­nima.">
            <div class="ico">ğŸ”</div>
            <div class="txt">
              <div class="t">Reenquadramento</div>
              <div class="d">Lembrete mental pra nÃ£o escalar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card full">
        <h3>Busca rÃ¡pida</h3>
        <p class="hint">Digite â€œgritoâ€, â€œafastarâ€, â€œvalidarâ€, â€œlimiteâ€ etc.</p>
        <input id="busca" type="search" placeholder="Buscar...">
      </div>

    </div>
  </section>

  <!-- DEPOIS -->
  <section class="panel" id="depois" style="display:none">
    <div class="grid">

      <div class="card full good">
        <h3>Depois que acalma</h3>
        <p class="hint">Validar â†’ nomear â†’ ajustar. Sem tribunal.</p>

        <div class="chips">
          <div class="tile" data-kind="script" data-tag="dp1" data-script="Agora que acalmou, acho que a gente consegue entender melhor o que aconteceu.">
            <div class="ico">ğŸ§©</div>
            <div class="txt">
              <div class="t">Abertura segura</div>
              <div class="d">ComeÃ§a sem acusaÃ§Ã£o.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="dp2" data-script="Eu reconheÃ§o que doeu. Eu nÃ£o quero te atacar.">
            <div class="ico">ğŸ«€</div>
            <div class="txt">
              <div class="t">Reconhecer dor</div>
              <div class="d">Sem entrar em defesa.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="dp3" data-script="O que piorou foi X. Da prÃ³xima vez, vamos fazer Y.">
            <div class="ico">ğŸ§­</div>
            <div class="txt">
              <div class="t">Ajuste prÃ¡tico (X â†’ Y)</div>
              <div class="d">Curto e executÃ¡vel.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card warn">
        <h3>Limite sem abandono</h3>
        <div class="chips">
          <div class="tile" data-kind="script" data-tag="lim1" data-script="Eu me importo com vocÃª. E eu preciso que a gente faÃ§a isso sem agressÃ£o.">
            <div class="ico">ğŸ§±</div>
            <div class="txt">
              <div class="t">Limite + vÃ­nculo</div>
              <div class="d">Firme sem humilhar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="lim2" data-script="Eu nÃ£o vou te abandonar. Mas eu tambÃ©m nÃ£o vou aceitar grito/ameaÃ§a.">
            <div class="ico">ğŸ›¡ï¸</div>
            <div class="txt">
              <div class="t">Firme e claro</div>
              <div class="d">Protege a relaÃ§Ã£o.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card full">
        <h3>Registro rÃ¡pido (vira prevenÃ§Ã£o)</h3>
        <p class="hint">1 linha: gatilho + o que ajudou.</p>
        <div class="bar">
          <input id="notaDepois" type="search" placeholder="Ex.: gatilho: atraso; ajudou: reduzir estÃ­mulo + frase X">
          <button class="btn primary" id="btnSalvarNota">Salvar</button>
        </div>
        <div class="mini" id="notaOk"></div>
      </div>

    </div>
  </section>

  <!-- PREVENÃ‡ÃƒO -->
  <section class="panel" id="prevencao" style="display:none">
    <div class="grid">

      <div class="card full good">
        <h3>PrevenÃ§Ã£o (regras do dia a dia)</h3>
        <div class="chips">
          <div class="tile" data-kind="action" data-tag="pv1" data-use="ComunicaÃ§Ã£o clara. Sem indireta. Sem sarcasmo.">
            <div class="ico">ğŸ§ </div>
            <div class="txt">
              <div class="t">Regra 1</div>
              <div class="d">Clareza reduz inseguranÃ§a.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>

          <div class="tile" data-kind="action" data-tag="pv2" data-use="Avisar mudanÃ§as com antecedÃªncia reduz ativaÃ§Ã£o.">
            <div class="ico">ğŸ“…</div>
            <div class="txt">
              <div class="t">Regra 2</div>
              <div class="d">Previsibilidade = menos crise.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>

          <div class="tile" data-kind="action" data-tag="pv3" data-use="Validar o sentimento antes de discordar protege o vÃ­nculo.">
            <div class="ico">ğŸ«€</div>
            <div class="txt">
              <div class="t">Regra 3</div>
              <div class="d">ValidaÃ§Ã£o vem antes do limite.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act" data-usebtn="1">â–¶ï¸</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card full">
        <h3>Acordos (curtos e executÃ¡veis)</h3>
        <p class="hint">Adicione e revise. Isso vira â€œregras do jogoâ€.</p>
        <div class="bar">
          <input id="acordoTxt" type="search" placeholder="Ex.: Se subir o tom â†’ pausa de 10 min; depois 1 frase de validaÃ§Ã£o">
          <button class="btn primary" id="btnAddAcordo">Adicionar</button>
        </div>

        <div class="list" id="acordosList" style="margin-top:10px"></div>

        <div class="row">
          <button class="btn" id="btnLimparAcordos">Limpar acordos</button>
        </div>
      </div>

      <div class="card bad full">
        <h3>Quando buscar ajuda</h3>
        <p class="hint">Crise frequente/intensa, risco, agressividade, exaustÃ£o do cuidador, ciclo repetido.</p>
        <div class="chips">
          <div class="tile" data-kind="script" data-tag="aj1" data-script="Se as crises estÃ£o aumentando ou hÃ¡ risco, a gente precisa de ajuda profissional.">
            <div class="ico">ğŸ“</div>
            <div class="txt">
              <div class="t">Frase prÃ¡tica</div>
              <div class="d">Sem atacar, sÃ³ encaminhar.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>

          <div class="tile" data-kind="script" data-tag="aj2" data-script="Pedir ajuda a tempo evita danos maiores depois.">
            <div class="ico">ğŸ§¯</div>
            <div class="txt">
              <div class="t">Fechamento</div>
              <div class="d">Curto e direto.</div>
            </div>
            <div class="actions">
              <button class="act" data-star="1">â˜…</button>
              <button class="act copy" data-copybtn="1">ğŸ“‹</button>
            </div>
          </div>
        </div>

        <div class="footer">
          Se houver risco imediato, priorize seguranÃ§a e suporte local.
        </div>
      </div>

    </div>
  </section>

</div>

<div class="toast" id="toast">OK</div>

<!-- MODAIS -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <h2 id="modalTitle">HistÃ³rico</h2>
    <p id="modalDesc"></p>
    <div class="hr"></div>
    <div class="list" id="modalList"></div>
    <div class="row">
      <button class="btn" id="modalClose">Fechar</button>
      <button class="btn danger" id="modalClear">Limpar</button>
    </div>
  </div>
</div>

<script>
/* ===== storage ===== */
const K = {
  hist: "gm_hist_v2",
  fav:  "gm_fav_v2",
  stats:"gm_stats_v2",
  acordos:"gm_acordos_v2",
};

const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

function read(k, fallback){
  try{ return JSON.parse(localStorage.getItem(k)) ?? fallback; }
  catch(e){ return fallback; }
}
function write(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

function pad(n){ return String(n).padStart(2,"0"); }
function fmtDT(ts){
  const d = new Date(ts);
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function todayKey(ts){
  const d=new Date(ts);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/* ===== toast ===== */
const toast = $("#toast");
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast.t);
  showToast.t = setTimeout(()=>toast.classList.remove("show"), 900);
}
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); }
  catch(e){
    const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); ta.remove();
  }
}

/* ===== stats ===== */
function bumpStat(key){
  const st = read(K.stats, {opens:0,copies:0,uses:0,timer:0,plans:0,notes:0,acordos:0});
  st[key] = (st[key]||0)+1;
  write(K.stats, st);
}
(function initOpen(){
  const st = read(K.stats, {opens:0,copies:0,uses:0,timer:0,plans:0,notes:0,acordos:0});
  st.opens = (st.opens||0)+1;
  write(K.stats, st);
})();

/* ===== history humano ===== */
function pushHist(type, title, detail){
  const hist = read(K.hist, []);
  const ev = { ts: Date.now(), type, title, detail: detail || "" };
  hist.unshift(ev);
  if(hist.length>200) hist.pop();
  write(K.hist, hist);
}

/* ===== favorites ===== */
function isFav(tag){ return read(K.fav, []).includes(tag); }
function toggleFav(tag){
  const fav = read(K.fav, []);
  const i=fav.indexOf(tag);
  if(i>=0) fav.splice(i,1); else fav.push(tag);
  write(K.fav, fav);
}
function applyFavUI(){
  $$("[data-tag]").forEach(el=>{
    const tag=el.dataset.tag;
    if(isFav(tag)) el.classList.add("fav"); else el.classList.remove("fav");
  });
}
applyFavUI();

/* ===== tabs ===== */
$$(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    $$(".panel").forEach(p=>p.style.display = (p.id===id) ? "block" : "none");
    window.scrollTo({top:0, behavior:"smooth"});
    pushHist("navegaÃ§Ã£o", "Aba aberta", id.toUpperCase());
  });
});

/* ===== busca ===== */
$("#busca").addEventListener("input", ()=>{
  const q = $("#busca").value.trim().toLowerCase();
  $$("[data-tag]").forEach(el=>{
    const payload = (el.innerText + " " + (el.dataset.script||"") + " " + (el.dataset.use||"")).toLowerCase();
    el.style.display = (!q || payload.includes(q)) ? "" : "none";
  });
});

/* ===== estrelas ===== */
$$("[data-star]").forEach(btn=>{
  btn.addEventListener("click",(e)=>{
    e.stopPropagation();
    const tile = btn.closest("[data-tag]");
    const tag  = tile?.dataset?.tag;
    if(!tag) return;
    toggleFav(tag);
    applyFavUI();
    showToast(isFav(tag) ? "â˜… Favoritado" : "â˜… Removido");
    pushHist("favorito", isFav(tag) ? "Adicionado" : "Removido", tag);
  });
});

/* ===== copiar scripts ===== */
$$("[data-copybtn]").forEach(btn=>{
  btn.addEventListener("click", async (e)=>{
    e.stopPropagation();
    const tile = btn.closest("[data-tag]");
    const text = tile?.dataset?.script || "";
    if(!text) return;
    await copyToClipboard(text);
    bumpStat("copies");
    showToast("ğŸ“‹ Copiado");
    pushHist("copiado", "Script copiado", text);
  });
});

/* ===== marcar aÃ§Ãµes como usadas ===== */
$$("[data-usebtn]").forEach(btn=>{
  btn.addEventListener("click",(e)=>{
    e.stopPropagation();
    const tile = btn.closest("[data-tag]");
    const text = tile?.dataset?.use || "";
    const title = tile?.querySelector(".t")?.innerText || "AÃ§Ã£o";
    if(!text) return;
    bumpStat("uses");
    showToast("âœ… Usado");
    pushHist("aÃ§Ã£o", title, text);
  });
});

/* ===== plano por intensidade ===== */
const planoMap = {
  "1": [
    "Tom baixo. Uma frase por vez.",
    "Valide + pausa curta.",
    "Evite corrigir conteÃºdo."
  ],
  "2": [
    "Reduz estÃ­mulo (ambiente).",
    "Uma frase de presenÃ§a.",
    "Timer 60s + repetir mantra."
  ],
  "3": [
    "Reduz estÃ­mulo AGORA (menos gente/ruÃ­do).",
    "NÃ£o discuta. SÃ³ presenÃ§a + limite curto.",
    "Se risco: buscar ajuda / afastar com seguranÃ§a."
  ]
};

$("#btnPlano").addEventListener("click", async ()=>{
  const v = $("#intensidade").value;
  if(v==="0"){ showToast("Selecione intensidade"); return; }
  bumpStat("plans");

  const steps = planoMap[v] || [];
  const txt = "Plano agora:\n- " + steps.join("\n- ");

  await copyToClipboard(txt);
  showToast("â–¶ï¸ Plano copiado");
  pushHist("plano", `Plano gerado (intensidade ${v})`, steps.join(" | "));
});

/* ===== timer ===== */
let timerOn=false, tLeft=60, tInt=null;
function setTimerLabel(){ $("#timerTxt").textContent = timerOn ? `Timer: ${tLeft}s` : "Timer: parado"; }

$("#btnTimer").addEventListener("click", ()=>{
  bumpStat("timer");

  if(!timerOn){
    timerOn=true; tLeft=60; setTimerLabel();
    $("#btnTimer").textContent="â¹ï¸ Parar";
    pushHist("timer", "Timer iniciado", "60s");

    tInt=setInterval(()=>{
      tLeft--;
      setTimerLabel();
      if(tLeft<=0){
        clearInterval(tInt); timerOn=false;
        $("#btnTimer").textContent="â±ï¸ Timer 60s";
        setTimerLabel();
        showToast("â±ï¸ 60s: repita 1 frase");
        pushHist("timer", "Timer finalizado", "Repetir 1 frase curta");
      }
    },1000);
  }else{
    clearInterval(tInt); timerOn=false;
    $("#btnTimer").textContent="â±ï¸ Timer 60s";
    setTimerLabel();
    showToast("Timer parado");
    pushHist("timer", "Timer interrompido", `${tLeft}s restantes`);
  }
});

/* ===== notas pÃ³s-crise ===== */
$("#btnSalvarNota").addEventListener("click", ()=>{
  const v = $("#notaDepois").value.trim();
  if(!v){ showToast("Escreva a nota"); return; }
  bumpStat("notes");
  pushHist("nota", "Registro pÃ³s-crise", v);
  $("#notaDepois").value="";
  $("#notaOk").textContent="Nota salva no HistÃ³rico.";
  setTimeout(()=>$("#notaOk").textContent="",1200);
  showToast("ğŸ“ Nota salva");
});

/* ===== acordos ===== */
function renderAcordos(){
  const arr = read(K.acordos, []);
  const box = $("#acordosList");
  box.innerHTML = arr.length
    ? arr.map((a,i)=>`<div class="item"><div class="t">Acordo ${i+1}</div><div class="m">${escapeHtml(a)}</div></div>`).join("")
    : `<div class="item"><div class="m">Sem acordos ainda.</div></div>`;
}
renderAcordos();

$("#btnAddAcordo").addEventListener("click", ()=>{
  const v = $("#acordoTxt").value.trim();
  if(!v){ showToast("Escreva o acordo"); return; }
  const arr = read(K.acordos, []);
  arr.unshift(v);
  if(arr.length>40) arr.pop();
  write(K.acordos, arr);
  $("#acordoTxt").value="";
  bumpStat("acordos");
  pushHist("acordo", "Acordo adicionado", v);
  renderAcordos();
  showToast("â• Acordo");
});

$("#btnLimparAcordos").addEventListener("click", ()=>{
  write(K.acordos, []);
  pushHist("acordo", "Acordos limpos", "");
  renderAcordos();
  showToast("Acordos limpos");
});

/* ===== modal ===== */
const modalBack = $("#modalBack");
const modalTitle = $("#modalTitle");
const modalDesc  = $("#modalDesc");
const modalList  = $("#modalList");
const modalClose = $("#modalClose");
const modalClear = $("#modalClear");
let modalMode="hist";

function openModal(mode){
  modalMode=mode;
  modalBack.style.display="flex";
  renderModal();
}
function closeModal(){ modalBack.style.display="none"; }
modalClose.addEventListener("click", closeModal);
modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

function renderModal(){
  if(modalMode==="hist"){
    modalTitle.textContent="HistÃ³rico";
    modalDesc.textContent="Log com data, hora e evento.";
    const hist = read(K.hist, []);

    if(!hist.length){
      modalList.innerHTML = `<div class="item"><div class="m">Sem histÃ³rico ainda.</div></div>`;
    }else{
      const groups = {};
      hist.forEach(h=>{
        const key = todayKey(h.ts);
        (groups[key] ||= []).push(h);
      });
      const keys = Object.keys(groups).sort((a,b)=>b.localeCompare(a));

      let html="";
      keys.forEach(k=>{
        const [Y,M,D]=k.split("-");
        html += `<div class="item"><div class="t">${D}/${M}/${Y}</div><div class="m">â€”</div></div>`;
        groups[k].forEach(h=>{
          html += `<div class="item">
            <div class="t">${escapeHtml(fmtDT(h.ts))} â€¢ ${escapeHtml(h.type)} â€¢ ${escapeHtml(h.title)}</div>
            <div class="m">${escapeHtml(h.detail)}</div>
          </div>`;
        });
      });
      modalList.innerHTML = html;
    }

    modalClear.style.display="";
    modalClear.textContent="Limpar histÃ³rico";
  }

  if(modalMode==="fav"){
    modalTitle.textContent="Favoritos";
    modalDesc.textContent="Itens marcados com â˜….";
    const fav = read(K.fav, []);
    if(!fav.length){
      modalList.innerHTML = `<div class="item"><div class="m">Sem favoritos ainda.</div></div>`;
    }else{
      const tiles = $$("[data-tag]").filter(el=>fav.includes(el.dataset.tag));
      modalList.innerHTML = tiles.length ? tiles.map(el=>{
        const title = el.querySelector(".t")?.innerText || el.dataset.tag;
        const txt = el.dataset.script || el.dataset.use || "";
        return `<div class="item"><div class="t">â˜… ${escapeHtml(title)}</div><div class="m">${escapeHtml(txt)}</div></div>`;
      }).join("") : `<div class="item"><div class="m">Favoritos nÃ£o encontrados.</div></div>`;
    }
    modalClear.style.display="";
    modalClear.textContent="Limpar favoritos";
  }

  if(modalMode==="stats"){
    modalTitle.textContent="Uso";
    modalDesc.textContent="MÃ©tricas locais (nÃ£o envia dados).";
    const st = read(K.stats, {opens:0,copies:0,uses:0,timer:0,plans:0,notes:0,acordos:0});
    modalList.innerHTML = `
      <div class="kpi">
        <div class="box"><div class="n">${st.opens||0}</div><div class="l">aberturas</div></div>
        <div class="box"><div class="n">${st.copies||0}</div><div class="l">cÃ³pias</div></div>
        <div class="box"><div class="n">${st.uses||0}</div><div class="l">aÃ§Ãµes usadas</div></div>
        <div class="box"><div class="n">${st.timer||0}</div><div class="l">timers</div></div>
        <div class="box"><div class="n">${st.plans||0}</div><div class="l">planos</div></div>
        <div class="box"><div class="n">${st.notes||0}</div><div class="l">notas</div></div>
        <div class="box"><div class="n">${st.acordos||0}</div><div class="l">acordos</div></div>
      </div>
      <div class="item"><div class="m">Se â€œaÃ§Ãµes usadasâ€ for baixo, estÃ£o lendo e nÃ£o aplicando na hora H.</div></div>
    `;
    modalClear.style.display="";
    modalClear.textContent="Zerar mÃ©tricas";
  }
}

modalClear.addEventListener("click", ()=>{
  if(modalMode==="hist"){ write(K.hist, []); showToast("HistÃ³rico limpo"); }
  if(modalMode==="fav"){ write(K.fav, []); applyFavUI(); showToast("Favoritos limpos"); }
  if(modalMode==="stats"){ write(K.stats, {opens:0,copies:0,uses:0,timer:0,plans:0,notes:0,acordos:0}); showToast("MÃ©tricas zeradas"); }
  renderModal();
});

$("#btnHistorico").addEventListener("click", ()=>openModal("hist"));
$("#btnFavoritos").addEventListener("click", ()=>openModal("fav"));
$("#btnStats").addEventListener("click", ()=>openModal("stats"));

/* ===== export TXT humano ===== */
$("#btnExportar").addEventListener("click", ()=>{
  const hist = read(K.hist, []);
  const acordos = read(K.acordos, []);
  const fav = read(K.fav, []);
  const st = read(K.stats, {opens:0,copies:0,uses:0,timer:0,plans:0,notes:0,acordos:0});

  const lines=[];
  lines.push("Guia de Manejo em Crise â€” ExportaÃ§Ã£o");
  lines.push("Gerado em: " + fmtDT(Date.now()));
  lines.push("");
  lines.push("=== Resumo de uso ===");
  lines.push(`Aberturas: ${st.opens||0}`);
  lines.push(`CÃ³pias: ${st.copies||0}`);
  lines.push(`AÃ§Ãµes usadas: ${st.uses||0}`);
  lines.push(`Timers: ${st.timer||0}`);
  lines.push(`Planos: ${st.plans||0}`);
  lines.push(`Notas: ${st.notes||0}`);
  lines.push(`Acordos criados: ${st.acordos||0}`);
  lines.push("");

  lines.push("=== Favoritos (tags) ===");
  lines.push(fav.length ? fav.join(", ") : "(sem favoritos)");
  lines.push("");

  lines.push("=== Acordos ===");
  if(acordos.length){
    acordos.forEach((a,i)=>lines.push(`${i+1}. ${a}`));
  }else{
    lines.push("(sem acordos)");
  }
  lines.push("");

  lines.push("=== HistÃ³rico (data/hora â€¢ tipo â€¢ tÃ­tulo â†’ detalhe) ===");
  if(hist.length){
    const groups={};
    hist.forEach(h=>{
      const key=todayKey(h.ts);
      (groups[key] ||= []).push(h);
    });
    const keys=Object.keys(groups).sort((a,b)=>b.localeCompare(a));
    keys.forEach(k=>{
      const [Y,M,D]=k.split("-");
      lines.push(`-- ${D}/${M}/${Y} --`);
      groups[k].forEach(h=>{
        lines.push(`${fmtDT(h.ts)} â€¢ ${h.type} â€¢ ${h.title} â†’ ${h.detail}`.trim());
      });
      lines.push("");
    });
  }else{
    lines.push("(sem histÃ³rico)");
  }

  const blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="guia_manejo_export.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("â¬‡ï¸ Exportado");
  pushHist("export", "ExportaÃ§Ã£o gerada", "TXT");
});

/* ===== modo crise ===== */
$("#btnEmergencia").addEventListener("click", ()=>{
  const tab = document.querySelector('.tab[data-tab="crise"]');
  tab.click();
  const el = document.documentElement;
  if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
  window.scrollTo({top:0, behavior:"smooth"});
  showToast("âš ï¸ Modo crise");
  pushHist("modo", "Modo crise ativado", "");
});

/* ===== PWA SW ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./guia-sw.js");
  });
}
</script>
</body>
</html>
