<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador Clínico — Documentos (Offline)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --paper:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --danger:#ef4444;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg, #071025 0%, #071327 60%, #061022 100%);
      color:#e5e7eb;
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      min-height:100vh;
    }

    .sidebar{
      padding:18px 16px;
      background:rgba(15,26,46,.92);
      border-right:1px solid rgba(148,163,184,.15);
      backdrop-filter: blur(8px);
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:12px 10px 14px;
      border:1px solid rgba(148,163,184,.15);
      border-radius:12px;
      background:rgba(2,6,23,.35);
      margin-bottom:14px;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:rgba(226,232,240,.72);
      line-height:1.35;
    }

    .sectionTitle{
      margin:12px 2px 8px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(226,232,240,.7);
    }

    .card{
      border:1px solid rgba(148,163,184,.15);
      border-radius:12px;
      background:rgba(2,6,23,.35);
      padding:12px;
      margin-bottom:12px;
    }

    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1;}
    .row.tight > *{flex:0 0 auto;}
    label{
      display:block;
      font-size:12px;
      color:rgba(226,232,240,.8);
      margin:8px 0 6px;
    }
    input, select, textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:82px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(226,232,240,.45)}
    .hint{
      font-size:12px;
      color:rgba(226,232,240,.62);
      line-height:1.35;
      margin-top:8px;
    }

    .btnRow{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    .btn{
      appearance:none;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(37,99,235,.16);
      color:#e5e7eb;
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn:hover{border-color:rgba(37,99,235,.6)}
    .btn.primary{background:linear-gradient(90deg, rgba(37,99,235,.75), rgba(14,165,233,.65)); border-color:rgba(56,189,248,.35)}
    .btn.ghost{background:rgba(2,6,23,.15)}
    .btn.danger{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35)}

    .chips{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.25);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{border-color:rgba(56,189,248,.55); background:rgba(37,99,235,.18)}

    .main{
      padding:18px;
    }

    .previewWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      max-width: 980px;
      margin:0 auto;
    }

    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.15);
      background:rgba(2,6,23,.25);
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .toolbar .meta{
      font-size:12px;
      color:rgba(226,232,240,.7);
    }

    /* Papel (visual na tela) */
    .paper{
      background:var(--paper);
      color:var(--text);
      border-radius:10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      border:1px solid rgba(148,163,184,.15);
      overflow:hidden;
    }

    .page{
      width: 210mm;
      min-height: 297mm;
      padding: 18mm 18mm 16mm;
      margin: 0 auto;
      background: var(--paper);
      position:relative;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      padding-bottom:10px;
      border-bottom:1px solid var(--line);
    }
    .docTitle{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:800;
    }
    .docSub{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .doctorBox{
      text-align:right;
      max-width: 48%;
    }
    .doctorName{
      font-weight:800;
      font-size:13px;
      margin:0;
    }
    .doctorMeta{
      margin:4px 0 0;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-line;
    }

    .content{padding-top:12px;}
    .block{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(107,114,128,.35);
    }
    .block:first-child{border-top:none; padding-top:0; margin-top:0;}
    .h{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#111827;
      margin:0 0 6px;
      font-weight:800;
    }
    .p{
      margin:0;
      font-size:12.5px;
      line-height:1.55;
      color:#111827;
      white-space:pre-line;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .fieldLine{
      border:1px solid rgba(229,231,235,.95);
      border-radius:10px;
      padding:10px;
    }
    .fieldLine .k{
      font-size:10.5px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      margin:0 0 6px;
      font-weight:700;
    }
    .fieldLine .v{
      margin:0;
      font-size:12.5px;
      line-height:1.35;
      color:#111827;
      white-space:pre-line;
    }

    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:12.5px;
    }
    .table th, .table td{
      border:1px solid var(--line);
      padding:8px 8px;
      vertical-align:top;
      text-align:left;
    }
    .table th{
      background:#f3f4f6;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#111827;
    }

    .footer{
      position:absolute;
      left:18mm;
      right:18mm;
      bottom:14mm;
      padding-top:10px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }
    .sig{
      width: 58%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sigLine{
      border-bottom:1px solid #111827;
      height:16px;
    }
    .sigMeta{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }
    .dateBox{
      width: 42%;
      text-align:right;
      font-size:11.5px;
      color:#111827;
    }
    .warn{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Print */
    @media print{
      body{background:#fff;}
      .sidebar,.toolbar{display:none !important;}
      .main{padding:0;}
      .paper{box-shadow:none; border:none;}
      .page{border:none; border-radius:0; width:auto; min-height:auto;}
    }

    /* Mobile */
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr;}
      .sidebar{position:relative}
      .page{width:auto; min-height:auto}
      .doctorBox{max-width: 55%;}
      .grid2{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <h1>Gerador Clínico (Offline)</h1>
      <p>1 arquivo HTML. Preenche, pré-visualiza e imprime/salva em PDF.<br>Sem internet. Dados salvos no seu navegador (localStorage).</p>
    </div>

    <div class="card">
      <div class="sectionTitle">Tipo de documento</div>
      <div class="chips" id="docChips"></div>

      <label>Preferências</label>
      <div class="row">
        <select id="dateMode">
          <option value="blank">Data em branco</option>
          <option value="today">Data de hoje automática</option>
        </select>
        <select id="layoutMode">
          <option value="standard">Layout padrão</option>
          <option value="twoCopies">Controle especial — 2 vias na mesma impressão</option>
        </select>
      </div>
      <div class="hint">
        “Controle especial” costuma exigir data para dispensação. Se quiser assinar depois no BirdID, deixe a assinatura em branco e use data automática só quando necessário.
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">Seus dados (fixos)</div>

      <label>Nome profissional</label>
      <input id="doc_name" placeholder="Ex.: Dr. Fulano de Tal" />

      <label>CRM/UF</label>
      <input id="doc_crm" placeholder="Ex.: CRM/SP 000000" />

      <label>Especialidade / RQE (opcional)</label>
      <input id="doc_spec" placeholder="Ex.: Psiquiatria — RQE 00000" />

      <label>Endereço profissional</label>
      <textarea id="doc_addr" placeholder="Rua..., nº..., Bairro..., Cidade/UF"></textarea>

      <label>Contato (opcional)</label>
      <input id="doc_contact" placeholder="Ex.: (11) 99999-9999 | e-mail | site" />

      <div class="btnRow">
        <button class="btn ghost" id="saveDoctor">Salvar</button>
        <button class="btn danger" id="resetDoctor">Limpar</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">Paciente</div>

      <label>Buscar paciente salvo</label>
      <select id="patientPick"></select>

      <div class="row">
        <div>
          <label>Nome</label>
          <input id="pt_name" placeholder="Nome completo" />
        </div>
        <div>
          <label>CPF (opcional)</label>
          <input id="pt_cpf" placeholder="000.000.000-00" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>RG (opcional)</label>
          <input id="pt_rg" placeholder="RG" />
        </div>
        <div>
          <label>Data nasc. (opcional)</label>
          <input id="pt_dob" placeholder="dd/mm/aaaa" />
        </div>
      </div>

      <label>Endereço</label>
      <textarea id="pt_addr" placeholder="Rua..., nº..., Bairro..., Cidade/UF"></textarea>

      <div class="btnRow">
        <button class="btn ghost" id="savePatient">Salvar paciente</button>
        <button class="btn danger" id="deletePatient">Excluir paciente</button>
      </div>
    </div>

    <div class="card" id="dynamicFormCard">
      <div class="sectionTitle">Campos do documento</div>
      <div id="dynamicForm"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">Ações</div>
      <div class="btnRow">
        <button class="btn primary" id="btnPrint">Imprimir / Salvar PDF</button>
        <button class="btn" id="btnCopyText">Copiar texto (corpo)</button>
      </div>
      <div class="hint">Dica: no desktop, “Imprimir” → “Salvar como PDF”. Em muitos navegadores isso preserva bem o A4.</div>
    </div>
  </aside>

  <main class="main">
    <div class="previewWrap">
      <div class="toolbar">
        <div class="left">
          <div class="meta" id="metaState">Pronto.</div>
        </div>
        <div class="right">
          <button class="btn ghost" id="btnExportBackup">Exportar backup (JSON)</button>
          <button class="btn ghost" id="btnImportBackup">Importar backup</button>
          <input type="file" id="backupFile" accept="application/json" style="display:none" />
        </div>
      </div>

      <div class="paper" id="paper">
        <div class="page" id="page">
          <!-- preview render -->
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  // =========================
  // Config / Storage helpers
  // =========================
  const LS_KEYS = {
    doctor: "gc_doctor_v1",
    patients: "gc_patients_v1",
    state: "gc_state_v1"
  };

  const $ = (id) => document.getElementById(id);

  const safeJSON = (s, fallback) => {
    try { return JSON.parse(s); } catch { return fallback; }
  };

  const todayBR = () => {
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  };

  const escapeHTML = (str="") => String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  // =========================
  // Doctor defaults (pre-fill)
  // =========================
  const DEFAULT_DOCTOR = {
    name: "Dr. Fabio Henrique de Lima Schmidt",
    crm: "CRM/SP 183549",
    spec: "",
    addr: "",
    contact: ""
  };

  // =========================
  // Document templates
  // =========================
  const DOCS = [
    { id:"rx_simple", label:"Receita simples" },
    { id:"rx_control", label:"Controle especial" },
    { id:"report_simple", label:"Relatório simples" },
    { id:"report_complex", label:"Relatório completo" },
    { id:"exam_request", label:"Pedido de exames" },
    { id:"declaration", label:"Declaração" },
    { id:"certificate", label:"Atestado" },
  ];

  // Fields per doc (dynamic form)
  // Types: text, textarea, list_meds, list_exams, select
  const DOC_FORMS = {
    rx_simple: [
      { key:"rx_heading", type:"text", label:"Cabeçalho interno (opcional)", placeholder:"Ex.: Receita médica" },
      { key:"rx_notes", type:"textarea", label:"Observações (opcional)", placeholder:"Ex.: Orientações gerais, retorno, etc." },
      { key:"rx_meds", type:"list_meds", label:"Medicamentos (adicione 1 por linha / item)" },
    ],
    rx_control: [
      { key:"rx_heading", type:"text", label:"Cabeçalho interno (opcional)", placeholder:"Ex.: Receita de Controle Especial" },
      { key:"rx_cid", type:"text", label:"CID (opcional)", placeholder:"Ex.: F60.3" },
      { key:"rx_qty_note", type:"text", label:"Nota de quantidade (opcional)", placeholder:"Ex.: Quantidade total para 30 dias" },
      { key:"rx_meds", type:"list_meds", label:"Medicamentos (adicione 1 por item)" },
      { key:"rx_notes", type:"textarea", label:"Observações (opcional)", placeholder:"Ex.: Posologia detalhada, alerta de uso, etc." },
    ],
    report_simple: [
      { key:"rep_purpose", type:"text", label:"Finalidade/objetivo", placeholder:"Ex.: Relatório médico" },
      { key:"rep_summary", type:"textarea", label:"Texto (curto e direto)", placeholder:"Ex.: Em acompanhamento psiquiátrico desde..., quadro compatível com..., conduta..., recomendações..." },
      { key:"rep_cid", type:"text", label:"CID (opcional)", placeholder:"Ex.: F60.3 / F41.1" },
    ],
    report_complex: [
      { key:"rep_purpose", type:"text", label:"Finalidade/objetivo", placeholder:"Ex.: Relatório médico detalhado" },
      { key:"rep_history", type:"textarea", label:"História clínica / evolução", placeholder:"Ex.: Queixa principal, início, curso, fatores, etc." },
      { key:"rep_exam", type:"textarea", label:"Exame do estado mental", placeholder:"Ex.: Aparência, humor, pensamento, percepção, risco, etc." },
      { key:"rep_hyp", type:"textarea", label:"Hipóteses diagnósticas", placeholder:"Ex.: ..." },
      { key:"rep_plan", type:"textarea", label:"Conduta / plano terapêutico", placeholder:"Ex.: ..." },
      { key:"rep_cid", type:"text", label:"CID (opcional)", placeholder:"Ex.: F60.3 / F41" },
      { key:"rep_reco", type:"textarea", label:"Recomendações e observações", placeholder:"Ex.: Afastamento, retorno, restrições, etc." },
    ],
    exam_request: [
      { key:"ex_reason", type:"text", label:"Justificativa (opcional)", placeholder:"Ex.: Avaliação basal / seguimento / queixa X" },
      { key:"ex_list", type:"list_exams", label:"Exames (adicione 1 por item)" },
      { key:"ex_notes", type:"textarea", label:"Observações (opcional)", placeholder:"Ex.: Jejum, horários, repetir em X semanas, etc." },
    ],
    declaration: [
      { key:"dec_title", type:"text", label:"Título", placeholder:"Declaração" },
      { key:"dec_body", type:"textarea", label:"Texto da declaração", placeholder:"Ex.: Declaro para os devidos fins que..." },
      { key:"dec_place", type:"text", label:"Local (opcional)", placeholder:"Ex.: São Paulo/SP" },
    ],
    certificate: [
      { key:"att_title", type:"text", label:"Título", placeholder:"Atestado" },
      { key:"att_days", type:"text", label:"Período (dias) ou intervalo", placeholder:"Ex.: 5 dias | 10/01/2026 a 15/01/2026" },
      { key:"att_body", type:"textarea", label:"Texto do atestado", placeholder:"Ex.: Atesto para os devidos fins que..." },
      { key:"att_place", type:"text", label:"Local (opcional)", placeholder:"Ex.: São Paulo/SP" },
      { key:"att_cid", type:"text", label:"CID (opcional)", placeholder:"Ex.: F60.3 / F41.1" },
    ],
  };

  // =========================
  // App state
  // =========================
  const state = {
    docType: "rx_control",
    dateMode: "blank",
    layoutMode: "standard",
    doctor: { ...DEFAULT_DOCTOR },
    patients: [],
    currentPatientId: null,
    docData: {} // dynamic per doc
  };

  const emptyDocDataFor = (docId) => {
    const base = {};
    (DOC_FORMS[docId] || []).forEach(f => {
      if (f.type === "list_meds" || f.type === "list_exams") base[f.key] = [];
      else base[f.key] = "";
    });
    return base;
  };

  // =========================
  // Patients helpers
  // =========================
  const newId = () => "p_" + Math.random().toString(16).slice(2) + Date.now().toString(16);

  const getPatientFromInputs = () => ({
    id: state.currentPatientId || newId(),
    name: $("pt_name").value.trim(),
    cpf: $("pt_cpf").value.trim(),
    rg: $("pt_rg").value.trim(),
    dob: $("pt_dob").value.trim(),
    addr: $("pt_addr").value.trim(),
    updatedAt: new Date().toISOString()
  });

  const loadPatientToInputs = (p) => {
    $("pt_name").value = p?.name || "";
    $("pt_cpf").value = p?.cpf || "";
    $("pt_rg").value = p?.rg || "";
    $("pt_dob").value = p?.dob || "";
    $("pt_addr").value = p?.addr || "";
  };

  const refreshPatientPick = () => {
    const sel = $("patientPick");
    const list = [...state.patients].sort((a,b)=> (b.updatedAt||"").localeCompare(a.updatedAt||""));
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "— selecionar —";
    sel.appendChild(opt0);

    list.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name ? `${p.name}` : `(sem nome) — ${p.id.slice(-6)}`;
      sel.appendChild(opt);
    });

    sel.value = state.currentPatientId || "";
  };

  // =========================
  // Render chips
  // =========================
  const renderChips = () => {
    const wrap = $("docChips");
    wrap.innerHTML = "";
    DOCS.forEach(d=>{
      const div = document.createElement("div");
      div.className = "chip" + (state.docType===d.id ? " active" : "");
      div.textContent = d.label;
      div.onclick = () => {
        state.docType = d.id;
        // reset docData for new doc if missing
        state.docData[d.id] = state.docData[d.id] || emptyDocDataFor(d.id);
        renderChips();
        renderDynamicForm();
        renderPreview();
        saveState();
      };
      wrap.appendChild(div);
    });
  };

  // =========================
  // Dynamic form builders
  // =========================
  const renderDynamicForm = () => {
    const docId = state.docType;
    const formDef = DOC_FORMS[docId] || [];
    const wrap = $("dynamicForm");
    wrap.innerHTML = "";

    if (!state.docData[docId]) state.docData[docId] = emptyDocDataFor(docId);

    formDef.forEach(field=>{
      const label = document.createElement("label");
      label.textContent = field.label;
      wrap.appendChild(label);

      if (field.type === "text") {
        const input = document.createElement("input");
        input.placeholder = field.placeholder || "";
        input.value = state.docData[docId][field.key] || "";
        input.oninput = () => { state.docData[docId][field.key] = input.value; renderPreview(); saveState(); };
        wrap.appendChild(input);
      }

      if (field.type === "textarea") {
        const ta = document.createElement("textarea");
        ta.placeholder = field.placeholder || "";
        ta.value = state.docData[docId][field.key] || "";
        ta.oninput = () => { state.docData[docId][field.key] = ta.value; renderPreview(); saveState(); };
        wrap.appendChild(ta);
      }

      if (field.type === "list_meds") {
        wrap.appendChild(buildListEditor(docId, field.key, "Adicionar medicamento", "Ex.: Sertralina 50 mg — 1 comp pela manhã — 30 dias"));
      }

      if (field.type === "list_exams") {
        wrap.appendChild(buildListEditor(docId, field.key, "Adicionar exame", "Ex.: Hemograma completo"));
      }
    });
  };

  const buildListEditor = (docId, key, addLabel, placeholder) => {
    const container = document.createElement("div");
    container.style.display = "grid";
    container.style.gap = "10px";

    const list = state.docData[docId][key] || [];
    const listWrap = document.createElement("div");
    listWrap.style.display="grid";
    listWrap.style.gap="8px";

    const rerender = () => {
      listWrap.innerHTML = "";
      (state.docData[docId][key] || []).forEach((item, idx) => {
        const row = document.createElement("div");
        row.className = "row tight";
        row.style.gap = "8px";

        const inp = document.createElement("input");
        inp.style.flex = "1 1 auto";
        inp.placeholder = placeholder || "";
        inp.value = item || "";
        inp.oninput = () => {
          state.docData[docId][key][idx] = inp.value;
          renderPreview(); saveState();
        };

        const up = document.createElement("button");
        up.className = "btn ghost";
        up.textContent = "↑";
        up.onclick = () => {
          if (idx===0) return;
          const arr = state.docData[docId][key];
          [arr[idx-1], arr[idx]] = [arr[idx], arr[idx-1]];
          rerender(); renderPreview(); saveState();
        };

        const down = document.createElement("button");
        down.className = "btn ghost";
        down.textContent = "↓";
        down.onclick = () => {
          const arr = state.docData[docId][key];
          if (idx===arr.length-1) return;
          [arr[idx+1], arr[idx]] = [arr[idx], arr[idx+1]];
          rerender(); renderPreview(); saveState();
        };

        const del = document.createElement("button");
        del.className = "btn danger";
        del.textContent = "✕";
        del.onclick = () => {
          state.docData[docId][key].splice(idx,1);
          rerender(); renderPreview(); saveState();
        };

        row.appendChild(inp);
        row.appendChild(up);
        row.appendChild(down);
        row.appendChild(del);
        listWrap.appendChild(row);
      });
    };

    const addBtn = document.createElement("button");
    addBtn.className = "btn";
    addBtn.textContent = addLabel;
    addBtn.onclick = () => {
      state.docData[docId][key] = state.docData[docId][key] || [];
      state.docData[docId][key].push("");
      rerender(); renderPreview(); saveState();
    };

    container.appendChild(listWrap);
    container.appendChild(addBtn);

    rerender();
    return container;
  };

  // =========================
  // Preview render
  // =========================
  const docLabel = (id) => (DOCS.find(d=>d.id===id)?.label || id);

  const getDoctor = () => ({
    name: $("doc_name").value.trim(),
    crm: $("doc_crm").value.trim(),
    spec: $("doc_spec").value.trim(),
    addr: $("doc_addr").value.trim(),
    contact: $("doc_contact").value.trim(),
  });

  const getPatient = () => ({
    name: $("pt_name").value.trim(),
    cpf: $("pt_cpf").value.trim(),
    rg: $("pt_rg").value.trim(),
    dob: $("pt_dob").value.trim(),
    addr: $("pt_addr").value.trim(),
  });

  const renderPreview = () => {
    $("metaState").textContent = `Documento: ${docLabel(state.docType)} • Data: ${state.dateMode==="today" ? todayBR() : "em branco"} • Layout: ${state.layoutMode}`;

    const doctor = getDoctor();
    const patient = getPatient();
    const docId = state.docType;
    const data = state.docData[docId] || emptyDocDataFor(docId);

    const baseHTML = buildDocumentHTML(docId, doctor, patient, data, state.dateMode);
    const page = $("page");

    if (docId === "rx_control" && state.layoutMode === "twoCopies") {
      // 2 vias: duplica o conteúdo com uma linha de corte
      page.innerHTML = `
        <div style="display:grid; gap:14mm;">
          <div>${baseHTML}</div>
          <div style="border-top:2px dashed #cbd5e1; padding-top:8mm;">
            <div style="font-size:11px; color:#6b7280; margin-bottom:6mm;">2ª via</div>
            ${baseHTML}
          </div>
        </div>
      `;
    } else {
      page.innerHTML = baseHTML;
    }
  };

  const buildDoctorMeta = (doctor) => {
    const lines = [
      doctor.crm || "",
      doctor.spec || "",
      doctor.addr || "",
      doctor.contact || "",
    ].filter(Boolean).join("\n");
    return escapeHTML(lines);
  };

  const buildPatientFields = (patient) => {
    const fields = [
      { k:"Paciente", v: patient.name || "—" },
      { k:"Endereço", v: patient.addr || "—" },
      { k:"CPF", v: patient.cpf || "—" },
      { k:"RG", v: patient.rg || "—" },
      { k:"Data de nascimento", v: patient.dob || "—" },
    ];
    return `
      <div class="grid2">
        <div class="fieldLine">
          <div class="k">${fields[0].k}</div>
          <div class="v">${escapeHTML(fields[0].v)}</div>
        </div>
        <div class="fieldLine">
          <div class="k">${fields[2].k}</div>
          <div class="v">${escapeHTML(fields[2].v)}</div>
        </div>
        <div class="fieldLine">
          <div class="k">${fields[1].k}</div>
          <div class="v">${escapeHTML(fields[1].v)}</div>
        </div>
        <div class="fieldLine">
          <div class="k">${fields[3].k} / ${fields[4].k}</div>
          <div class="v">${escapeHTML(fields[3].v)}${fields[4].v && fields[4].v!=="—" ? " • " + escapeHTML(fields[4].v) : ""}</div>
        </div>
      </div>
    `;
  };

  const buildFooter = (doctor, dateMode, placeHint) => {
    const dateText = (dateMode === "today") ? todayBR() : "";
    const place = (placeHint || "").trim();
    const right = place && dateText ? `${escapeHTML(place)}, ${escapeHTML(dateText)}` :
                 place ? `${escapeHTML(place)}` :
                 dateText ? `${escapeHTML(dateText)}` : "";
    return `
      <div class="footer">
        <div class="sig">
          <div class="sigLine"></div>
          <div class="sigMeta">
            ${escapeHTML(doctor.name || "—")}<br>
            ${escapeHTML(doctor.crm || "—")}
          </div>
        </div>
        <div class="dateBox">
          ${right ? right : `<span style="color:#6b7280">Data em branco</span>`}
        </div>
      </div>
    `;
  };

  const buildMedsTable = (items=[]) => {
    const rows = (items || []).filter(x=>String(x||"").trim().length>0);
    if (!rows.length) {
      return `<div class="warn">Nenhum medicamento preenchido.</div>`;
    }
    return `
      <table class="table">
        <thead>
          <tr><th>Prescrição</th></tr>
        </thead>
        <tbody>
          ${rows.map(r=>`<tr><td>${escapeHTML(r)}</td></tr>`).join("")}
        </tbody>
      </table>
    `;
  };

  const buildExamsTable = (items=[]) => {
    const rows = (items || []).filter(x=>String(x||"").trim().length>0);
    if (!rows.length) {
      return `<div class="warn">Nenhum exame preenchido.</div>`;
    }
    return `
      <table class="table">
        <thead>
          <tr><th>Exames solicitados</th></tr>
        </thead>
        <tbody>
          ${rows.map(r=>`<tr><td>${escapeHTML(r)}</td></tr>`).join("")}
        </tbody>
      </table>
    `;
  };

  const buildDocumentHTML = (docId, doctor, patient, data, dateMode) => {
    const doctorMeta = buildDoctorMeta(doctor);
    const title = docLabel(docId);

    // Header common
    const header = `
      <div class="header">
        <div>
          <h2 class="docTitle">${escapeHTML(title)}</h2>
          <p class="docSub">Documento gerado para impressão em A4. Assinatura manual/digital no final.</p>
        </div>
        <div class="doctorBox">
          <p class="doctorName">${escapeHTML(doctor.name || "—")}</p>
          <p class="doctorMeta">${doctorMeta || "—"}</p>
        </div>
      </div>
    `;

    const patientBlock = `
      <div class="block">
        <div class="h">Identificação</div>
        ${buildPatientFields(patient)}
      </div>
    `;

    // Body per doc
    let body = "";

    if (docId === "rx_simple") {
      const heading = (data.rx_heading || "").trim();
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">${escapeHTML(heading || "Prescrição")}</div>
          ${buildMedsTable(data.rx_meds)}
          ${data.rx_notes?.trim() ? `<div class="warn"><b>Observações:</b> ${escapeHTML(data.rx_notes.trim())}</div>` : ""}
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, "")}`;
    }

    if (docId === "rx_control") {
      const heading = (data.rx_heading || "").trim();
      const cid = (data.rx_cid || "").trim();
      const qty = (data.rx_qty_note || "").trim();
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">${escapeHTML(heading || "Receita de Controle Especial")}</div>
          ${cid ? `<div class="warn"><b>CID:</b> ${escapeHTML(cid)}</div>` : ""}
          ${qty ? `<div class="warn"><b>Quantidade:</b> ${escapeHTML(qty)}</div>` : ""}
          ${buildMedsTable(data.rx_meds)}
          ${data.rx_notes?.trim() ? `<div class="warn"><b>Observações:</b> ${escapeHTML(data.rx_notes.trim())}</div>` : ""}
          <div class="warn">Atenção: alguns dispensários exigem data preenchida. Ajuste em “Preferências”.</div>
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, "")}`;
    }

    if (docId === "report_simple") {
      const purpose = (data.rep_purpose || "Relatório médico").trim();
      const cid = (data.rep_cid || "").trim();
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">${escapeHTML(purpose)}</div>
          <div class="p">${escapeHTML((data.rep_summary||"").trim() || "—")}</div>
          ${cid ? `<div class="warn"><b>CID:</b> ${escapeHTML(cid)}</div>` : ""}
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, "")}`;
    }

    if (docId === "report_complex") {
      const purpose = (data.rep_purpose || "Relatório médico detalhado").trim();
      const cid = (data.rep_cid || "").trim();
      const sections = [
        { t:"História clínica / evolução", v:data.rep_history },
        { t:"Exame do estado mental", v:data.rep_exam },
        { t:"Hipóteses diagnósticas", v:data.rep_hyp },
        { t:"Conduta / plano terapêutico", v:data.rep_plan },
        { t:"Recomendações e observações", v:data.rep_reco },
      ];
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">${escapeHTML(purpose)}</div>
          ${sections.map(s=>`
            <div style="margin-top:10px;">
              <div class="h" style="letter-spacing:.08em;">${escapeHTML(s.t)}</div>
              <div class="p">${escapeHTML((s.v||"").trim() || "—")}</div>
            </div>
          `).join("")}
          ${cid ? `<div class="warn"><b>CID:</b> ${escapeHTML(cid)}</div>` : ""}
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, "")}`;
    }

    if (docId === "exam_request") {
      const reason = (data.ex_reason || "").trim();
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">Pedido de exames</div>
          ${reason ? `<div class="warn"><b>Justificativa:</b> ${escapeHTML(reason)}</div>` : ""}
          ${buildExamsTable(data.ex_list)}
          ${data.ex_notes?.trim() ? `<div class="warn"><b>Observações:</b> ${escapeHTML(data.ex_notes.trim())}</div>` : ""}
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, "")}`;
    }

    if (docId === "declaration") {
      const title2 = (data.dec_title || "Declaração").trim();
      const place = (data.dec_place || "").trim();
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">${escapeHTML(title2)}</div>
          <div class="p">${escapeHTML((data.dec_body||"").trim() || "—")}</div>
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, place)}`;
    }

    if (docId === "certificate") {
      const title2 = (data.att_title || "Atestado").trim();
      const place = (data.att_place || "").trim();
      const days = (data.att_days || "").trim();
      const cid = (data.att_cid || "").trim();
      body = `
        ${patientBlock}
        <div class="block">
          <div class="h">${escapeHTML(title2)}</div>
          ${days ? `<div class="warn"><b>Período:</b> ${escapeHTML(days)}</div>` : ""}
          <div class="p">${escapeHTML((data.att_body||"").trim() || "—")}</div>
          ${cid ? `<div class="warn"><b>CID:</b> ${escapeHTML(cid)}</div>` : ""}
        </div>
      `;
      return `${header}<div class="content">${body}</div>${buildFooter(doctor, dateMode, place)}`;
    }

    // fallback
    return `${header}<div class="content">${patientBlock}</div>${buildFooter(doctor, dateMode, "")}`;
  };

  // =========================
  // Persistence
  // =========================
  const saveDoctorToState = () => {
    state.doctor = getDoctor();
    localStorage.setItem(LS_KEYS.doctor, JSON.stringify(state.doctor));
  };

  const loadDoctorFromState = () => {
    const saved = safeJSON(localStorage.getItem(LS_KEYS.doctor), null);
    const d = saved || DEFAULT_DOCTOR;
    state.doctor = d;

    $("doc_name").value = d.name || "";
    $("doc_crm").value = d.crm || "";
    $("doc_spec").value = d.spec || "";
    $("doc_addr").value = d.addr || "";
    $("doc_contact").value = d.contact || "";
  };

  const savePatientsToState = () => {
    localStorage.setItem(LS_KEYS.patients, JSON.stringify(state.patients));
  };

  const loadPatientsFromState = () => {
    state.patients = safeJSON(localStorage.getItem(LS_KEYS.patients), []);
  };

  const saveState = () => {
    const payload = {
      docType: state.docType,
      dateMode: state.dateMode,
      layoutMode: state.layoutMode,
      currentPatientId: state.currentPatientId,
      docData: state.docData
    };
    localStorage.setItem(LS_KEYS.state, JSON.stringify(payload));
  };

  const loadState = () => {
    const saved = safeJSON(localStorage.getItem(LS_KEYS.state), null);
    if (!saved) return;

    state.docType = saved.docType || state.docType;
    state.dateMode = saved.dateMode || state.dateMode;
    state.layoutMode = saved.layoutMode || state.layoutMode;
    state.currentPatientId = saved.currentPatientId || null;
    state.docData = saved.docData || {};
  };

  // =========================
  // Backup import/export
  // =========================
  const exportBackup = () => {
    const backup = {
      version: 1,
      exportedAt: new Date().toISOString(),
      doctor: getDoctor(),
      patients: state.patients,
      state: {
        docType: state.docType,
        dateMode: state.dateMode,
        layoutMode: state.layoutMode,
        docData: state.docData
      }
    };
    const blob = new Blob([JSON.stringify(backup, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup-gerador-clinico-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  const importBackupFromFile = async (file) => {
    const text = await file.text();
    const data = safeJSON(text, null);
    if (!data || !data.version) {
      alert("Backup inválido.");
      return;
    }
    // merge
    if (data.doctor) {
      localStorage.setItem(LS_KEYS.doctor, JSON.stringify(data.doctor));
    }
    if (Array.isArray(data.patients)) {
      localStorage.setItem(LS_KEYS.patients, JSON.stringify(data.patients));
    }
    if (data.state) {
      localStorage.setItem(LS_KEYS.state, JSON.stringify({
        docType: data.state.docType || state.docType,
        dateMode: data.state.dateMode || state.dateMode,
        layoutMode: data.state.layoutMode || state.layoutMode,
        currentPatientId: null,
        docData: data.state.docData || {}
      }));
    }
    // reload
    boot();
    alert("Backup importado.");
  };

  // =========================
  // Copy body text (useful)
  // =========================
  const buildBodyPlainText = () => {
    const docId = state.docType;
    const patient = getPatient();
    const data = state.docData[docId] || {};
    let out = [];
    out.push(`${docLabel(docId)}`.toUpperCase());
    out.push(`Paciente: ${patient.name || "—"}`);
    if (patient.addr) out.push(`Endereço: ${patient.addr}`);
    if (patient.cpf) out.push(`CPF: ${patient.cpf}`);
    if (patient.rg) out.push(`RG: ${patient.rg}`);
    if (patient.dob) out.push(`Nascimento: ${patient.dob}`);
    out.push("");

    const add = (k,v) => {
      const t = (v||"").trim();
      if (t) out.push(`${k}: ${t}`);
    };

    if (docId.startsWith("rx_")) {
      const meds = (data.rx_meds || []).filter(x=>String(x||"").trim());
      if (data.rx_heading) out.push(data.rx_heading.trim());
      if (data.rx_cid) add("CID", data.rx_cid);
      if (data.rx_qty_note) add("Quantidade", data.rx_qty_note);
      out.push("");
      meds.forEach((m,i)=> out.push(`${i+1}. ${m.trim()}`));
      if (data.rx_notes) { out.push(""); out.push("Observações:"); out.push(data.rx_notes.trim()); }
    } else if (docId === "report_simple") {
      add("Finalidade", data.rep_purpose || "Relatório médico");
      out.push("");
      out.push((data.rep_summary||"").trim() || "—");
      if (data.rep_cid) add("CID", data.rep_cid);
    } else if (docId === "report_complex") {
      add("Finalidade", data.rep_purpose || "Relatório médico detalhado");
      out.push("");
      add("História clínica / evolução", data.rep_history);
      out.push("");
      add("Exame do estado mental", data.rep_exam);
      out.push("");
      add("Hipóteses diagnósticas", data.rep_hyp);
      out.push("");
      add("Conduta / plano terapêutico", data.rep_plan);
      out.push("");
      add("Recomendações e observações", data.rep_reco);
      if (data.rep_cid) { out.push(""); add("CID", data.rep_cid); }
    } else if (docId === "exam_request") {
      if (data.ex_reason) add("Justificativa", data.ex_reason);
      out.push("");
      (data.ex_list||[]).filter(x=>String(x||"").trim()).forEach((e,i)=> out.push(`${i+1}. ${e.trim()}`));
      if (data.ex_notes) { out.push(""); out.push("Observações:"); out.push(data.ex_notes.trim()); }
    } else if (docId === "declaration") {
      out.push((data.dec_title||"Declaração").trim());
      out.push("");
      out.push((data.dec_body||"").trim() || "—");
      if (data.dec_place) add("Local", data.dec_place);
    } else if (docId === "certificate") {
      out.push((data.att_title||"Atestado").trim());
      if (data.att_days) add("Período", data.att_days);
      out.push("");
      out.push((data.att_body||"").trim() || "—");
      if (data.att_cid) add("CID", data.att_cid);
      if (data.att_place) add("Local", data.att_place);
    }

    return out.join("\n");
  };

  // =========================
  // Wire events
  // =========================
  const wire = () => {
    // Preferences
    $("dateMode").value = state.dateMode;
    $("layoutMode").value = state.layoutMode;

    $("dateMode").onchange = () => { state.dateMode = $("dateMode").value; renderPreview(); saveState(); };
    $("layoutMode").onchange = () => { state.layoutMode = $("layoutMode").value; renderPreview(); saveState(); };

    // Doctor inputs live update preview
    ["doc_name","doc_crm","doc_spec","doc_addr","doc_contact"].forEach(id=>{
      $(id).oninput = () => { renderPreview(); };
    });

    $("saveDoctor").onclick = () => { saveDoctorToState(); renderPreview(); alert("Dados do médico salvos."); };
    $("resetDoctor").onclick = () => {
      localStorage.removeItem(LS_KEYS.doctor);
      loadDoctorFromState();
      renderPreview();
    };

    // Patient pick
    $("patientPick").onchange = () => {
      const id = $("patientPick").value || null;
      state.currentPatientId = id;
      const p = state.patients.find(x=>x.id===id);
      loadPatientToInputs(p);
      renderPreview();
      saveState();
    };

    // Patient inputs live update preview
    ["pt_name","pt_cpf","pt_rg","pt_dob","pt_addr"].forEach(id=>{
      $(id).oninput = () => { renderPreview(); };
    });

    $("savePatient").onclick = () => {
      const p = getPatientFromInputs();
      if (!p.name) {
        alert("Preencha pelo menos o nome do paciente.");
        return;
      }
      const idx = state.patients.findIndex(x=>x.id===p.id);
      if (idx >= 0) state.patients[idx] = p;
      else state.patients.push(p);

      state.currentPatientId = p.id;
      savePatientsToState();
      refreshPatientPick();
      saveState();
      alert("Paciente salvo.");
    };

    $("deletePatient").onclick = () => {
      const id = state.currentPatientId;
      if (!id) { alert("Selecione um paciente salvo primeiro."); return; }
      const p = state.patients.find(x=>x.id===id);
      if (!p) { alert("Paciente não encontrado."); return; }
      if (!confirm(`Excluir paciente "${p.name}"?`)) return;

      state.patients = state.patients.filter(x=>x.id!==id);
      state.currentPatientId = null;
      savePatientsToState();
      refreshPatientPick();
      loadPatientToInputs(null);
      renderPreview();
      saveState();
    };

    // Print
    $("btnPrint").onclick = () => {
      // ensure docData exists
      state.docData[state.docType] = state.docData[state.docType] || emptyDocDataFor(state.docType);
      saveState();
      window.print();
    };

    // Copy body
    $("btnCopyText").onclick = async () => {
      const text = buildBodyPlainText();
      try {
        await navigator.clipboard.writeText(text);
        alert("Texto copiado.");
      } catch {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        alert("Texto copiado.");
      }
    };

    // Backup export/import
    $("btnExportBackup").onclick = () => exportBackup();
    $("btnImportBackup").onclick = () => $("backupFile").click();
    $("backupFile").onchange = () => {
      const f = $("backupFile").files?.[0];
      if (f) importBackupFromFile(f);
      $("backupFile").value = "";
    };
  };

  // =========================
  // Boot
  // =========================
  const boot = () => {
    loadDoctorFromState();
    loadPatientsFromState();
    loadState();

    // Ensure docData exists for all docs (lazy ok)
    state.docData[state.docType] = state.docData[state.docType] || emptyDocDataFor(state.docType);

    renderChips();
    refreshPatientPick();

    // apply preferences selects
    $("dateMode").value = state.dateMode;
    $("layoutMode").value = state.layoutMode;

    renderDynamicForm();
    renderPreview();
    wire();
  };

  boot();
</script>
</body>
</html>
