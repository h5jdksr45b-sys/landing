<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Plano Terap√™utico ‚Äì Lucas Baldi</title>

<style>
  :root{
    --bg:#0b1220;
    --card:#0f1a2e;
    --card2:#0c1628;
    --ink:#e7eefc;
    --muted:#a9b6d3;
    --line:rgba(255,255,255,.12);
    --accent:#7c3aed;
    --accent2:#22c55e;
    --warn:#f59e0b;
    --danger:#ef4444;
    --radius:16px;
    --shadow:0 16px 46px rgba(0,0,0,.48);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:var(--sans);
    color:var(--ink);
    background:
      radial-gradient(1200px 700px at 25% 10%, rgba(124,58,237,.22), transparent 60%),
      radial-gradient(1000px 650px at 78% 18%, rgba(34,197,94,.12), transparent 60%),
      radial-gradient(900px 700px at 50% 88%, rgba(245,158,11,.10), transparent 60%),
      var(--bg);
    min-height:100vh;
  }
  .wrap{max-width:1080px;margin:0 auto;padding:22px 14px 60px;}
  .top{
    display:flex;gap:14px;flex-wrap:wrap;align-items:stretch;justify-content:space-between;
    margin-bottom:14px;
  }
  .brand{
    flex:1 1 560px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:18px 18px 16px;
    box-shadow:var(--shadow);
    position:relative; overflow:hidden;
  }
  .brand:before{
    content:"";
    position:absolute; inset:-60px -90px auto auto;
    width:240px;height:240px;
    background:radial-gradient(circle at 30% 30%, rgba(124,58,237,.42), rgba(124,58,237,0) 62%);
    transform:rotate(12deg);
    pointer-events:none;
  }
  .brand h1{margin:0 0 6px;font-size:18px;letter-spacing:.2px}
  .brand p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
  .meta{
    flex:0 1 360px; min-width:280px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:14px 14px 12px;
    box-shadow:var(--shadow);
    display:flex;flex-direction:column;gap:10px;
  }
  .pillrow{display:flex;gap:8px;flex-wrap:wrap}
  .pill{
    font-size:12px; padding:7px 10px;border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--muted);
    display:flex;align-items:center;gap:8px;
    user-select:none;
  }
  .dot{width:7px;height:7px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px rgba(124,58,237,.12)}
  .dot.g{background:var(--accent2);box-shadow:0 0 0 4px rgba(34,197,94,.10)}
  .dot.w{background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.10)}
  .dot.r{background:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.12)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--ink);
    padding:9px 11px;
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
    display:inline-flex;align-items:center;gap:8px;
    transition:.15s ease;
  }
  .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
  .btn.primary{border-color:rgba(124,58,237,.55);background:rgba(124,58,237,.18)}
  .btn.danger{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.14)}
  .btn.ghost{background:transparent}

  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 12px}
  .tab{
    padding:10px 12px;border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--muted);
    font-weight:800;font-size:13px;
    cursor:pointer; user-select:none;
    transition:.15s ease;
  }
  .tab.active{
    color:var(--ink);
    border-color:rgba(124,58,237,.55);
    background:rgba(124,58,237,.20);
    box-shadow:0 10px 22px rgba(124,58,237,.10);
  }

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;align-items:start}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{
    border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.02));
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .hd{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
  .hint{font-size:12px;color:var(--muted)}
  .bd{padding:16px}
  .callout{
    padding:12px 12px;border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    margin-bottom:12px;
    color:var(--muted);
    line-height:1.45;
    font-size:13px;
  }
  .callout strong{color:var(--ink)}
  .callout.accent{border-color:rgba(124,58,237,.45);background:rgba(124,58,237,.12);color:#ddd8ff}
  .callout.warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.10);color:#ffe6b5}
  .callout.danger{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.10);color:#ffd2d2}

  .list{display:flex;flex-direction:column;gap:10px}
  .item{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:14px;
    padding:12px 12px;
  }
  .ttl{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px}
  .ttl b{font-size:13px}
  .ttl span{font-family:var(--mono);font-size:11px;color:var(--muted)}
  .item p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .field{flex:1 1 220px;display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  label{font-size:12px;color:var(--muted);font-weight:800}
  input[type="text"], textarea, select{
    width:100%;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    color:var(--ink);
    outline:none;
    font-size:13px;
    transition:.15s ease;
  }
  textarea{min-height:92px;resize:vertical}
  input:focus, textarea:focus, select:focus{
    border-color:rgba(124,58,237,.55);
    box-shadow:0 0 0 4px rgba(124,58,237,.12);
  }
  .help{font-size:12px;color:var(--muted);line-height:1.35}

  .checklist{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .ck{
    display:flex;gap:10px;align-items:flex-start;
    padding:10px 10px;border:1px solid var(--line);
    border-radius:14px;background:rgba(255,255,255,.02);
    transition:.15s ease;
  }
  .ck:hover{background:rgba(255,255,255,.04)}
  .ck input{margin-top:2px;transform:scale(1.1)}
  .ck .txt{display:flex;flex-direction:column;gap:3px}
  .ck .txt b{font-size:13px}
  .ck .txt span{font-size:12px;color:var(--muted);line-height:1.35}
  .progress{
    margin-top:10px;height:10px;border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    overflow:hidden;
  }
  .bar{
    height:100%;width:0%;
    background:linear-gradient(90deg, rgba(124,58,237,.95), rgba(34,197,94,.85));
    transition:.25s ease;
  }

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  @media(max-width:560px){.kpis{grid-template-columns:1fr}}
  .kpi{
    border:1px solid var(--line);
    border-radius:14px;
    background:rgba(255,255,255,.02);
    padding:10px 10px;
  }
  .kpi .n{font-size:18px;font-weight:950;letter-spacing:.2px}
  .kpi .t{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}

  .ratio{
    position:relative;width:100%;
    padding-top:56.25%;
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.02);
  }
  .ratio iframe{position:absolute;inset:0;width:100%;height:100%}

  /* Respira√ß√£o interativa */
  .breathWrap{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:14px;
    padding:12px 12px;
  }
  .breathTop{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    margin-bottom:10px;
  }
  .phase{
    font-family:var(--mono);
    font-size:12px;
    color:var(--muted);
  }
  .circle{
    width:160px;height:160px;border-radius:50%;
    border:1px solid rgba(255,255,255,.14);
    background:radial-gradient(circle at 30% 30%, rgba(124,58,237,.25), rgba(255,255,255,.02) 60%);
    box-shadow:0 16px 50px rgba(0,0,0,.45);
    margin:10px auto 12px;
    transform:scale(.78);
  }
  .circle.anim{
    transition: transform 4s linear;
  }
  .circle.inhale{transform:scale(1.0)}
  .circle.hold{transform:scale(1.0)}
  .circle.exhale{transform:scale(.75)}
  .breathBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .mini{
    font-size:12px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--ink);
    cursor:pointer;
    font-weight:800;
  }
  .mini:hover{background:rgba(255,255,255,.05)}
  .mini.primary{border-color:rgba(124,58,237,.55);background:rgba(124,58,237,.18)}
  .mini.warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.12)}
  .mini.danger{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.12)}

  /* Tabela scripts */
  .table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .table th, .table td{
    text-align:left;
    padding:10px 10px;
    border-bottom:1px solid var(--line);
    vertical-align:top;
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }
  .table th{
    color:var(--muted);
    background:rgba(255,255,255,.02);
    font-weight:900;
  }
  .table td b{color:var(--ink)}
  .table tr:last-child td{border-bottom:none}

  /* Toast */
  .toast{
    position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
    background:rgba(15,26,46,.95);
    border:1px solid rgba(255,255,255,.14);
    color:rgba(231,238,252,.95);
    padding:10px 12px;
    border-radius:999px;
    box-shadow:0 14px 40px rgba(0,0,0,.45);
    z-index:60;
    font-size:13px;
    opacity:0;
    pointer-events:none;
    transition:.25s ease;
  }
  .toast.on{opacity:1}

  @media print{
    body{background:#fff;color:#000}
    .tabs,.toolbar{display:none !important}
    .panel{box-shadow:none;border:1px solid #ddd}
    .wrap{max-width:980px}
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <h1>Plano Terap√™utico Integrado ‚Äì Lucas Baldi</h1>
      <p>
        Uso terap√™utico ambulatorial ‚Ä¢ Foco: manejo de crise, impulsividade, comunica√ß√£o e suporte familiar.<br>
        <b>Dr. Fabio Henrique de Lima Schmidt ‚Äì CRM/SP 183549</b>
      </p>
    </div>

    <div class="meta">
      <div class="pillrow">
        <div class="pill"><span class="dot"></span> Plano ativo</div>
        <div class="pill"><span class="dot g"></span> Foco: habilidades</div>
        <div class="pill"><span class="dot w"></span> Crise = pausa</div>
        <div class="pill"><span class="dot r"></span> Linha vermelha: amea√ßa</div>
      </div>
      <div class="toolbar">
        <button class="btn primary" id="btnPrint">üñ®Ô∏è Imprimir</button>
        <button class="btn" id="btnExport">‚§ì Exportar</button>
        <button class="btn danger" id="btnReset">‚ü≤ Reset</button>
      </div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="t1">Crise agora</div>
    <div class="tab" data-tab="t2">Coping & respira√ß√£o</div>
    <div class="tab" data-tab="t3">Fam√≠lia: scripts & checklists</div>
    <div class="tab" data-tab="t4">Fam√≠lia: comunica√ß√£o</div>
    <div class="tab" data-tab="t5">Sobre o TPB</div>
  </div>

  <div class="grid">
    <!-- Main -->
    <div class="panel">
      <div class="hd">
        <h2 id="panelTitle">Crise agora</h2>
        <div class="hint" id="panelHint">Se est√° ativado: procedimento > conversa.</div>
      </div>
      <div class="bd" id="panelBody"></div>
    </div>

    <!-- Sidebar -->
    <div class="panel">
      <div class="hd">
        <h2>Marcadores</h2>
        <div class="hint">Progresso local</div>
      </div>
      <div class="bd">
        <div class="callout accent">
          <strong>Regra-m√£e</strong><br>
          Urg√™ncia n√£o √© prova. √â sintoma. Seu objetivo agora √© <b>n√£o piorar</b>.
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="n" id="kpiDays">0</div>
            <div class="t">dias desde recome√ßo</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiChecks">0%</div>
            <div class="t">checklist</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiCopies">0</div>
            <div class="t">scripts copiados</div>
          </div>
        </div>

        <div class="progress"><div class="bar" id="bar"></div></div>

        <div class="checklist" id="checklist"></div>

        <div style="margin-top:12px" class="help">
          Tudo aqui √© salvo <b>neste dispositivo</b>. Se abrir em outro celular, n√£o aparece.
        </div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;color:rgba(169,182,211,.9);font-size:12px;margin-top:18px;">
    Material terap√™utico individual (ambulatorial) ‚Ä¢ N√£o substitui atendimento presencial em emerg√™ncia.
  </footer>
</div>

<div class="toast" id="toast">Copiado.</div>

<script>
/* =========================
   CONFIG
========================= */
const IMG_INFOGRAFICO = "https://raw.githubusercontent.com/h5jdksr45b-sys/landing/main/Controlando%20a%20Impulsividade%20no%20TPB.png";

/* =========================
   STATE (localStorage)
========================= */
const KEY = "lucasbaldi_plano_final_v1";
const defaultState = () => ({
  version: "final-1.0",
  patient: "Lucas Baldi",
  startDate: new Date().toISOString().slice(0,10),
  copies: 0,
  checklist: {
    pause: false,
    leave: false,
    noThreat: false,
    noAlcohol: false,
    returnTime: false,
    breathe: false
  },
  family: {
    phraseCode: "PAUSA LIMPA",
    returnMinutes: 20,
    eventPlan: "Sem discutir na volta. Conversa no dia seguinte.",
  }
});
function loadState(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return { ...defaultState(), ...parsed, checklist: {...defaultState().checklist, ...(parsed.checklist||{})}, family:{...defaultState().family, ...(parsed.family||{})} };
  }catch(e){ return defaultState(); }
}
function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
let state = loadState();

const $ = (sel)=>document.querySelector(sel);
const todayISO = ()=>new Date().toISOString().slice(0,10);
function daysBetween(aISO,bISO){
  const a=new Date(aISO+"T00:00:00");
  const b=new Date(bISO+"T00:00:00");
  return Math.max(0, Math.round((b-a)/(1000*60*60*24)));
}
function esc(str=""){ return (str+"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("on");
  setTimeout(()=>t.classList.remove("on"), 1200);
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    state.copies = (state.copies||0)+1;
    saveState(state);
    refreshKPIs();
    toast("Copiado.");
  }catch(e){
    toast("N√£o foi poss√≠vel copiar.");
  }
}

/* =========================
   CHECKLIST
========================= */
const CHECK_ITEMS = [
  {key:"pause", title:"Pausa imediata", desc:"Eu pauso discuss√£o assim que ativar."},
  {key:"leave", title:"Afastamento f√≠sico", desc:"Eu saio do ambiente para reduzir escalada."},
  {key:"noThreat", title:"Sem amea√ßa", desc:"Amea√ßa/intimida√ß√£o √© linha vermelha. N√£o uso."},
  {key:"noAlcohol", title:"Sem √°lcool/subst√¢ncias", desc:"Eu n√£o uso isso para ‚Äòacalmar‚Äô porque piora controle."},
  {key:"returnTime", title:"Retorno garantido", desc:"Eu marco hor√°rio para retomar, ou aviso no hor√°rio."},
  {key:"breathe", title:"Respira√ß√£o guiada", desc:"Eu fa√ßo 2 minutos de respira√ß√£o antes de falar qualquer coisa."}
];
function renderChecklist(){
  const box=$("#checklist");
  box.innerHTML = CHECK_ITEMS.map(it=>{
    const checked = !!state.checklist[it.key];
    return `
      <div class="ck">
        <input type="checkbox" ${checked?"checked":""} onchange="toggleChecklist('${it.key}', this.checked)" />
        <div class="txt">
          <b>${esc(it.title)}</b>
          <span>${esc(it.desc)}</span>
        </div>
      </div>
    `;
  }).join("");
  updateProgress();
}
function toggleChecklist(key,val){
  state.checklist[key]=!!val;
  saveState(state);
  updateProgress();
}
function updateProgress(){
  const total = CHECK_ITEMS.length;
  const done = Object.values(state.checklist).filter(Boolean).length;
  const pct = Math.round((done/total)*100);
  $("#bar").style.width = pct+"%";
  $("#kpiChecks").textContent = pct+"%";
}

/* =========================
   KPI
========================= */
function refreshKPIs(){
  $("#kpiDays").textContent = daysBetween(state.startDate, todayISO());
  $("#kpiChecks").textContent = $("#kpiChecks").textContent || "0%";
  $("#kpiCopies").textContent = state.copies || 0;
}

/* =========================
   RESPIRA√á√ÉO GUIADA (4-4-6)
========================= */
let breathTimer=null;
let breathRunning=false;
let breathCycle=0;
let breathConfig={inhale:4, hold:4, exhale:6, cycles:5};

function setPhase(text){
  const el=$("#breathPhase");
  if(el) el.textContent = text;
}
function setCircle(phase){
  const c=$("#breathCircle");
  if(!c) return;
  c.classList.add("anim");
  c.classList.remove("inhale","hold","exhale");
  c.classList.add(phase);
}
function stopBreath(){
  breathRunning=false;
  if(breathTimer) clearTimeout(breathTimer);
  breathTimer=null;
  setPhase("Pronto. Se estiver ativado, n√£o converse: execute a pausa.");
  const c=$("#breathCircle");
  if(c){
    c.classList.remove("anim","inhale","hold","exhale");
  }
}
function runBreathStep(step){
  if(!breathRunning) return;

  const {inhale, hold, exhale, cycles} = breathConfig;
  const steps = [
    {name:"Inspire", sec: inhale, phase:"inhale"},
    {name:"Segure", sec: hold, phase:"hold"},
    {name:"Expire", sec: exhale, phase:"exhale"},
  ];

  const current = steps[step % 3];
  setCircle(current.phase);

  let remaining = current.sec;
  setPhase(`${current.name} ‚Äî ${remaining}s`);

  const tick = () => {
    if(!breathRunning) return;
    remaining--;
    if(remaining <= 0){
      // next step
      const nextStep = (step+1);
      if(nextStep % 3 === 0) breathCycle++; // completed one full cycle after exhale
      if(breathCycle >= cycles){
        state.checklist.breathe = true;
        saveState(state);
        renderChecklist();
        refreshKPIs();
        setPhase("Conclu√≠do. Agora: pausa + retorno garantido.");
        breathRunning=false;
        breathTimer=null;
        return;
      }
      breathTimer = setTimeout(()=>runBreathStep(nextStep), 50);
      return;
    }
    setPhase(`${current.name} ‚Äî ${remaining}s`);
    breathTimer = setTimeout(tick, 1000);
  };
  breathTimer = setTimeout(tick, 1000);
}
function startBreath(){
  if(breathRunning) return;
  breathRunning=true;
  breathCycle=0;
  runBreathStep(0);
}

/* =========================
   TABS CONTENT
========================= */
const TABS = {
  t1:{
    title:"Crise agora",
    hint:"Se est√° ativado: procedimento > conversa.",
    render:()=>`
      <div class="callout danger">
        <strong>Prioridade de seguran√ßa</strong><br>
        Em escalada emocional: <b>pausa</b> + <b>afastamento f√≠sico</b>. A conversa vem depois.
      </div>

      <div class="list">
        <div class="item">
          <div class="ttl"><b>Script de interrup√ß√£o imediata</b><span>copiar/usar</span></div>
          <p>‚ÄúEu estou ativado e n√£o sou confi√°vel agora. Vou pausar ${esc(state.family.returnMinutes)} minutos e volto em hor√°rio marcado.‚Äù</p>
          <p style="margin-top:8px;">‚ÄúEu n√£o quero te ferir. Eu preciso baixar a ativa√ß√£o antes de conversar.‚Äù</p>
          <div class="row" style="margin-top:8px">
            <button class="btn" onclick="copyText('Eu estou ativado e n√£o sou confi√°vel agora. Vou pausar ${state.family.returnMinutes} minutos e volto em hor√°rio marcado.')">üìã Copiar 1</button>
            <button class="btn" onclick="copyText('Eu n√£o quero te ferir. Eu preciso baixar a ativa√ß√£o antes de conversar.')">üìã Copiar 2</button>
          </div>
        </div>

        <div class="item">
          <div class="ttl"><b>Proibido em crise</b><span>linha vermelha</span></div>
          <p>Amea√ßa/intimida√ß√£o ‚Ä¢ confronto ‚Ä¢ mensagens repetidas ‚Ä¢ ‚Äús√≥ mais uma frase‚Äù ‚Ä¢ √°lcool/subst√¢ncias.</p>
        </div>

        <div class="item">
          <div class="ttl"><b>Retorno garantido</b><span>previsibilidade</span></div>
          <p>‚Äú${esc(state.family.phraseCode)}. Eu volto em ${esc(state.family.returnMinutes)} minutos. Se eu n√£o voltar, eu aviso no hor√°rio.‚Äù</p>
          <button class="btn" onclick="copyText('${state.family.phraseCode}. Eu volto em ${state.family.returnMinutes} minutos. Se eu n√£o voltar, eu aviso no hor√°rio.')">üìã Copiar</button>
        </div>
      </div>

      <div class="callout warn" style="margin-top:12px">
        <strong>Se o impulso vier forte</strong><br>
        N√£o tente ‚Äúexplicar‚Äù. Execute: <b>pausa + afastamento f√≠sico + respira√ß√£o (aba Coping)</b>.
      </div>

      <div class="row">
        <button class="btn primary" onclick="resetStart()">üîÅ Recome√ßar contador hoje</button>
        <button class="btn" onclick="goTab('t2')">ü´Å Ir para respira√ß√£o</button>
      </div>
    `
  },

  t2:{
    title:"Coping & respira√ß√£o",
    hint:"Baixar corpo antes de tentar pensar.",
    render:()=>`
      <div class="callout accent">
        <strong>Respira√ß√£o guiada (4‚Äì4‚Äì6)</strong><br>
        Inspire 4s ‚Ä¢ segure 4s ‚Ä¢ expire 6s. Fa√ßa 5 ciclos.
      </div>

      <div class="breathWrap">
        <div class="breathTop">
          <div>
            <div style="font-weight:950">Respira√ß√£o interativa</div>
            <div class="phase" id="breathPhase">Pronto. Se estiver ativado, n√£o converse: execute a pausa.</div>
          </div>
          <div class="pill" title="Configura√ß√£o padr√£o">
            <span class="dot g"></span> 4‚Äì4‚Äì6 ‚Ä¢ 5 ciclos
          </div>
        </div>

        <div class="circle" id="breathCircle" aria-label="anima√ß√£o de respira√ß√£o"></div>

        <div class="breathBtns">
          <button class="mini primary" onclick="startBreath()">‚ñ∂ Iniciar</button>
          <button class="mini warn" onclick="stopBreath()">‚è∏ Parar</button>
        </div>

        <div class="help" style="margin-top:10px">
          Meta: reduzir ativa√ß√£o. Voc√™ n√£o precisa ‚Äúresolver‚Äù. Voc√™ precisa <b>n√£o escalar</b>.
        </div>
      </div>

      <div class="callout" style="margin-top:12px">
        <strong>Coping r√°pido (10 minutos, sem negocia√ß√£o)</strong><br>
        1) √°gua fria no rosto + respira√ß√£o<br>
        2) caminhada r√°pida sem celular<br>
        3) escrever: ‚Äúo que eu acho / 3 alternativas / o que eu preciso‚Äù
      </div>

      <div class="item">
        <div class="ttl"><b>Mapa visual (consulta r√°pida)</b><span>infogr√°fico</span></div>
        <p>Use para relembrar o mecanismo ‚Äúalarme forte + freio fraco‚Äù e a l√≥gica do intervalo consciente.</p>
        <img src="${IMG_INFOGRAFICO}" alt="Infogr√°fico: Controlando a Impulsividade no TPB" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10);margin-top:10px;">
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" onclick="state.checklist.pause=true; saveState(state); renderChecklist(); updateProgress(); toast('Checklist atualizado: pausa.');">‚úÖ Marcar ‚Äúpausa‚Äù</button>
        <button class="btn" onclick="goTab('t1')">‚ö° Voltar para crise agora</button>
      </div>
    `
  },

  t3:{
    title:"Fam√≠lia: scripts & checklists",
    hint:"Valida√ß√£o + limite. Sem debate em crise.",
    render:()=>`
      <div class="callout warn">
        <strong>Para a fam√≠lia</strong><br>
        Este material √© para aumentar seguran√ßa e reduzir escalada. Em crise: <b>pausa e limite</b>.
      </div>

      <div class="item">
        <div class="ttl"><b>Checklist da fam√≠lia em crise</b><span>execut√°vel</span></div>
        <div class="list">
          <div class="item" style="background:rgba(255,255,255,.01)">
            <div class="ttl"><b>1) N√£o discutir</b><span>regra</span></div>
            <p>‚ÄúEu n√£o vou discutir agora. Eu volto quando voc√™ estiver regulado.‚Äù</p>
            <button class="btn" onclick="copyText('Eu n√£o vou discutir agora. Eu volto quando voc√™ estiver regulado.')">üìã Copiar</button>
          </div>
          <div class="item" style="background:rgba(255,255,255,.01)">
            <div class="ttl"><b>2) Validar sem concordar</b><span>t√©cnica</span></div>
            <p>‚ÄúEu entendi que voc√™ ficou inseguro. Isso n√£o justifica amea√ßa. Pausa agora.‚Äù</p>
            <button class="btn" onclick="copyText('Eu entendi que voc√™ ficou inseguro. Isso n√£o justifica amea√ßa. Pausa agora.')">üìã Copiar</button>
          </div>
          <div class="item" style="background:rgba(255,255,255,.01)">
            <div class="ttl"><b>3) Limite claro</b><span>seguran√ßa</span></div>
            <p>‚ÄúSe voc√™ levantar o tom / insistir / intimidar, eu me afasto e retomo depois.‚Äù</p>
            <button class="btn" onclick="copyText('Se voc√™ levantar o tom, insistir ou intimidar, eu me afasto e retomo depois.')">üìã Copiar</button>
          </div>
        </div>
      </div>

      <div class="callout danger">
        <strong>Linha vermelha</strong><br>
        Amea√ßa e intimida√ß√£o n√£o s√£o ‚Äúru√≠do emocional‚Äù. S√£o quebra de seguran√ßa.
        A fam√≠lia deve priorizar <b>afastamento e ajuda externa</b> se houver risco.
      </div>

      <div class="item">
        <div class="ttl"><b>Scripts prontos (fam√≠lia)</b><span>copiar/colar</span></div>
        <table class="table">
          <thead>
            <tr>
              <th style="width:220px">Situa√ß√£o</th>
              <th>Script</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><b>Quando ele ativa</b></td>
              <td>‚ÄúEu estou vendo que voc√™ est√° ativado. Eu me importo, mas n√£o vou discutir agora. Pausa e retorno.‚Äù</td>
            </tr>
            <tr>
              <td><b>Quando ele acusa</b></td>
              <td>‚ÄúEu entendi seu medo. Mas acusa√ß√£o agora s√≥ piora. Vamos pausar e retomar com calma.‚Äù</td>
            </tr>
            <tr>
              <td><b>Quando ele pede prova</b></td>
              <td>‚ÄúEu posso te dar seguran√ßa, mas n√£o sob press√£o. Pausa primeiro, conversa depois.‚Äù</td>
            </tr>
            <tr>
              <td><b>Quando a conversa voltar</b></td>
              <td>‚ÄúUm problema por vez. Um pedido concreto. Sem reabrir tudo.‚Äù</td>
            </tr>
          </tbody>
        </table>

        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="copyText('Eu estou vendo que voc√™ est√° ativado. Eu me importo, mas n√£o vou discutir agora. Pausa e retorno.')">üìã Copiar 1</button>
          <button class="btn" onclick="copyText('Eu entendi seu medo. Mas acusa√ß√£o agora s√≥ piora. Vamos pausar e retomar com calma.')">üìã Copiar 2</button>
          <button class="btn" onclick="copyText('Eu posso te dar seguran√ßa, mas n√£o sob press√£o. Pausa primeiro, conversa depois.')">üìã Copiar 3</button>
        </div>
      </div>

      <div class="callout">
        <strong>Mini-regra do casal</strong><br>
        ‚ÄúSem conversa na volta do evento social. S√≥ check-in b√°sico e descanso. Conversa no dia seguinte.‚Äù
      </div>
    `
  },

  t4:{
    title:"Fam√≠lia: comunica√ß√£o",
    hint:"Comunica√ß√£o, valida√ß√£o e previsibilidade (fam√≠lia).",
    render:()=>`
      <div class="callout accent">
        <strong>Tr√™s pilares</strong><br>
        <b>Valida√ß√£o</b> (reconhecer emo√ß√£o) + <b>Previsibilidade</b> (retorno garantido) + <b>Comunica√ß√£o</b> (pedido concreto).
      </div>

      <div class="row">
        <div class="field">
          <label>Frase-c√≥digo (pausa)</label>
          <input type="text" id="phraseCode" value="${esc(state.family.phraseCode)}" />
        </div>
        <div class="field">
          <label>Minutos de pausa</label>
          <select id="returnMinutes">
            ${[15,20,30,40].map(n=>`<option value="${n}" ${state.family.returnMinutes==n?"selected":""}>${n}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="field">
        <label>Plano para eventos sociais (combinado do casal)</label>
        <textarea id="eventPlan">${esc(state.family.eventPlan)}</textarea>
        <div class="help">Objetivo: reduzir ambiguidade. Ambiguidade vira gatilho.</div>
      </div>

      <div class="row">
        <button class="btn primary" onclick="saveFamily()">üíæ Salvar</button>
        <button class="btn" onclick="copyText('${state.family.phraseCode}. Eu volto em ${state.family.returnMinutes} minutos. Se eu n√£o voltar, eu aviso no hor√°rio.')">üìã Copiar frase de pausa</button>
      </div>

      <div class="item" style="margin-top:12px">
        <div class="ttl"><b>Scripts ‚Äúpedido concreto‚Äù (para evitar acusa√ß√£o)</b><span>modelo</span></div>
        <table class="table">
          <thead>
            <tr>
              <th style="width:220px">Em vez de‚Ä¶</th>
              <th>Use‚Ä¶</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>‚ÄúVoc√™ t√° me ignorando.‚Äù</td>
              <td>‚ÄúEu fiquei inseguro. Voc√™ pode me dizer onde voc√™ est√° / como voc√™ est√°?‚Äù</td>
            </tr>
            <tr>
              <td>‚ÄúVoc√™ riu de mim.‚Äù</td>
              <td>‚ÄúMinha cabe√ßa interpretou isso mal. Voc√™ pode me explicar?‚Äù</td>
            </tr>
            <tr>
              <td>‚ÄúEnt√£o termina.‚Äù</td>
              <td>‚ÄúEu estou ativado. Pausa. Eu volto e converso.‚Äù</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="callout warn" style="margin-top:12px">
        <strong>Princ√≠pio anti-escalada</strong><br>
        Quando a emo√ß√£o sobe, a fam√≠lia n√£o ‚Äúvence debate‚Äù. A fam√≠lia <b>muda o ponto de partida</b>: pausa + retorno + pedido concreto.
      </div>
    `
  },

  t5:{
    title:"Sobre o TPB",
    hint:"Explica√ß√£o clara, sem estigma, com foco pr√°tico.",
    render:()=>`
      <div class="callout">
        <strong>O que √© TPB (explica√ß√£o pr√°tica)</strong><br>
        TPB √© um padr√£o de funcionamento em que o sistema emocional ativa r√°pido e forte.
        O problema n√£o √© ‚Äúcar√°ter‚Äù ‚Äî √© <b>regula√ß√£o</b> + <b>interpreta√ß√£o</b> sob estresse.
      </div>

      <div class="list">
        <div class="item">
          <div class="ttl"><b>Tr√™s mecanismos que importam aqui</b><span>clareza</span></div>
          <p>
            1) <b>Alarme</b> (amea√ßa de rejei√ß√£o/abandono) fica hiperativo.<br>
            2) <b>Freio</b> (planejamento/inibi√ß√£o) falha quando a ativa√ß√£o sobe.<br>
            3) <b>Ambiguidade</b> vira ‚Äúprova‚Äù no c√©rebro ativado ‚Äî e a√≠ vem a urg√™ncia.
          </p>
        </div>

        <div class="item">
          <div class="ttl"><b>O que melhora com tratamento</b><span>realista</span></div>
          <p>
            ‚Ä¢ aumento do ‚Äúintervalo‚Äù entre sentir e agir<br>
            ‚Ä¢ melhor comunica√ß√£o de necessidades<br>
            ‚Ä¢ redu√ß√£o de impulsos em crise<br>
            ‚Ä¢ reparo mais r√°pido depois de ativa√ß√£o
          </p>
        </div>

        <div class="item">
          <div class="ttl"><b>O que N√ÉO √©</b><span>sem ru√≠do</span></div>
          <p>
            ‚Ä¢ n√£o √© desculpa para amea√ßa/intimida√ß√£o<br>
            ‚Ä¢ n√£o √© ‚Äúmaldade‚Äù como regra<br>
            ‚Ä¢ n√£o se resolve com ‚Äúfor√ßa de vontade‚Äù no pico do alarme ‚Äî se resolve com <b>procedimento</b>
          </p>
        </div>
      </div>

      <div class="callout accent" style="margin-top:12px">
        <strong>Frase para lembrar</strong><br>
        ‚ÄúQuando eu fico com medo, meu c√©rebro vira urg√™ncia. Eu n√£o preciso resolver agora. Eu preciso n√£o piorar agora.‚Äù
      </div>

      <div class="row">
        <button class="btn" onclick="copyText('Quando eu fico com medo, meu c√©rebro vira urg√™ncia. Eu n√£o preciso resolver agora. Eu preciso n√£o piorar agora.')">üìã Copiar frase</button>
        <button class="btn" onclick="goTab('t2')">ü´Å Ir para respira√ß√£o</button>
      </div>
    `
  }
};

/* =========================
   TAB RENDER
========================= */
let currentTab="t1";
function renderTab(key){
  currentTab=key;
  const t=TABS[key];
  $("#panelTitle").textContent=t.title;
  $("#panelHint").textContent=t.hint;
  $("#panelBody").innerHTML=t.render();

  // se saiu da aba respira√ß√£o, para o timer
  if(key!=="t2") stopBreath();
}
function goTab(key){
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${key}"]`).classList.add("active");
  renderTab(key);
}

/* =========================
   FAMILY SAVE
========================= */
function saveFamily(){
  const pc = document.getElementById("phraseCode");
  const rm = document.getElementById("returnMinutes");
  const ep = document.getElementById("eventPlan");
  if(pc) state.family.phraseCode = pc.value.trim() || "PAUSA LIMPA";
  if(rm) state.family.returnMinutes = parseInt(rm.value,10) || 20;
  if(ep) state.family.eventPlan = ep.value.trim() || state.family.eventPlan;
  saveState(state);
  toast("Salvo.");
  // re-render pra atualizar scripts que dependem desses campos
  renderTab(currentTab);
}

/* =========================
   EXPORT / RESET / PRINT
========================= */
function exportData(){
  const lines=[];
  lines.push(`Plano ‚Äì ${state.patient} (${state.version})`);
  lines.push(`Data: ${todayISO()}`);
  lines.push(`In√≠cio (contador): ${state.startDate}`);
  lines.push(`C√≥pias de scripts: ${state.copies||0}`);
  lines.push(`--- Checklist`);
  CHECK_ITEMS.forEach(it=>{
    lines.push(`- [${state.checklist[it.key]?"x":" "}] ${it.title}`);
  });
  lines.push(`--- Fam√≠lia`);
  lines.push(`Frase-c√≥digo: ${state.family.phraseCode}`);
  lines.push(`Minutos pausa: ${state.family.returnMinutes}`);
  lines.push(`Plano eventos: ${state.family.eventPlan}`);
  lines.push(`---`);
  const blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="lucasbaldi_plano_export.txt";
  document.body.appendChild(a);
  a.click(); a.remove();
  URL.revokeObjectURL(url);
  toast("Exportado.");
}
function resetAll(){
  if(!confirm("Apagar tudo salvo neste dispositivo?")) return;
  localStorage.removeItem(KEY);
  state = loadState();
  renderChecklist();
  refreshKPIs();
  renderTab(currentTab);
  toast("Reset conclu√≠do.");
}
function resetStart(){
  state.startDate = todayISO();
  saveState(state);
  refreshKPIs();
  toast("Contador reiniciado.");
}

/* =========================
   INIT
========================= */
document.getElementById("tabs").addEventListener("click",(e)=>{
  const t=e.target.closest(".tab");
  if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  renderTab(t.dataset.tab);
});

document.getElementById("btnPrint").onclick=()=>window.print();
document.getElementById("btnExport").onclick=exportData;
document.getElementById("btnReset").onclick=resetAll;

renderChecklist();
refreshKPIs();
renderTab("t1");
</script>
</body>
</html>
